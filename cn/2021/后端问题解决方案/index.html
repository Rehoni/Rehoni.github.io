<!DOCTYPE html>
<html lang="en-us">

  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>后端——问题小书（2021） - Rehoni | 罗皓</title>
    <meta property="og:title" content="后端——问题小书（2021） - Rehoni | 罗皓">
    
    <meta name="twitter:card" content="summary">

    
    
      
    

    
      
      <meta property="description" content="具体描述
[&amp;hellip;] Cannot forward to error page for request [/wechat/portal] as the response has already been commit
[&amp;hellip;] 解决方案和原理
使用response输出流或@ResponseBody
[&amp;hellip;] &amp;hellip;">
      <meta property="og:description" content="具体描述
[&amp;hellip;] Cannot forward to error page for request [/wechat/portal] as the response has already been commit
[&amp;hellip;] 解决方案和原理
使用response输出流或@ResponseBody
[&amp;hellip;] &amp;hellip;">
      
    

    
    
    
    
    <meta name="twitter:image" content="//localhost:1313/images/logo.jpg">
    
    

    

    
    


<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/monokai-sublime.min.css">



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
<script async src="/js/load-typekit.js"></script>


<link rel="stylesheet" href="/css/custom.css" />

  </head>
  <body class="cn">
    <header class="masthead">
      

<h1><a href="/"><img src="/images/logo.jpg" alt="Luo Hao" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/cn/about/">关于</a></li>
  
  <li><a href="/cn/">日志</a></li>
  
  <li><a href="/categories/">分类</a></li>
  
  <li><a href="/tags/">标签</a></li>
  
  <li><a href="/cn/vitae/">简历</a></li>
  
  <li><a href="/en/">English</a></li>
  
  

<li class="menu-extra"></li>



<li><a href="https://github.com/rehonicn%5c2021%5c%e5%90%8e%e7%ab%af%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88.md" target="_blank">编辑</a></li>


<li><a href="/cn/index.xml" type="application/rss+xml" title="RSS feed">订阅</a></li>

<li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="Attribution-NonCommercial-ShareAlike 4.0 International">版权</a></li>


  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>后端——问题小书（2021）</h1>


<h3>rehoni / 
2021-12-29</h3>

<hr>


      </header>





<h2 id="问题1cannot-forward-to-error-page-for-request">问题1：Cannot forward to error page for request</h2>
<p><strong>具体描述</strong></p>
<blockquote>
<p>Cannot forward to error page for request [/wechat/portal] as the response has already been commit</p>
</blockquote>
<p><strong>解决方案和原理</strong></p>
<p>使用response输出流或@ResponseBody</p>
<blockquote>
<p>response.getWriter().print(echostr);</p>
<p>@responseBody注解的作用是将controller的方法返回的对象通过适当的转换器转换为指定的格式之后，写入到response对象的body区，通常用来返回JSON数据或者是XML数据，需要注意的呢，在使用此注解之后不会再走试图处理器，而是直接将数据写入到流中，他的效果等同于通过response对象输出指定格式的数据。</p>
<p>因此可知之前直接使用return echostr spring会找不到对应的视图，但是视图找不到，spring又转到errorPage，但是项目中没有配置errorPage，从而404.</p>
</blockquote>
<h2 id="问题2文件上传功能报错">问题2、文件上传功能报错</h2>
<p><strong>具体描述</strong></p>
<blockquote>
<p>Current request is not a multipart request</p>
</blockquote>
<p><strong>解决方案和原理</strong></p>
<p>是postmapping而不是getmapping</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApiOperation</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;测试图片上传&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@PostMapping</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/upload&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Result <span style="color:#a6e22e">handleFileUpload</span>(<span style="color:#a6e22e">@RequestParam</span> List<span style="color:#f92672">&lt;</span>MultipartFile<span style="color:#f92672">&gt;</span> files) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">buildSuccess</span>(
</span></span><span style="display:flex;"><span>                storageService.<span style="color:#a6e22e">storeByString</span>(files)
</span></span><span style="display:flex;"><span>        ).<span style="color:#a6e22e">setMsg</span>(<span style="color:#e6db74">&#34;You successfully uploaded &#34;</span> <span style="color:#f92672">+</span> files.<span style="color:#a6e22e">size</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;files !&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="问题3httpclient警告">问题3、httpClient警告</h2>
<p><strong>具体描述</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-prolog" data-lang="prolog"><span style="display:flex;"><span> Warning<span style="color:#e6db74">：“</span>Going <span style="color:#e6db74">to</span> <span style="color:#e6db74">buffer</span> <span style="color:#e6db74">response</span> <span style="color:#e6db74">body</span> <span style="color:#e6db74">of</span> <span style="color:#e6db74">large</span> <span style="color:#e6db74">or</span> <span style="color:#e6db74">unknown</span> <span style="color:#e6db74">size</span>.Using <span style="color:#e6db74">getResponseBodyAsStream</span> <span style="color:#e6db74">instead</span> <span style="color:#e6db74">isrecommended</span>.<span style="color:#e6db74">”</span>
</span></span></code></pre></div><p><strong>解决方案和原理</strong></p>
<p>字面意思，稍微大的文件建议以流的方式而不是字符串的方式来读取body，解决方案：<code>getResponseBodyAsStream</code>替代<code>getResponseBodyAsString</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">try</span> (InputStream input <span style="color:#f92672">=</span> postMethod.<span style="color:#a6e22e">getResponseBodyAsStream</span>();
</span></span><span style="display:flex;"><span>      BufferedReader br <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> InputStreamReader(input, charSet))) {
</span></span><span style="display:flex;"><span>     String temp;
</span></span><span style="display:flex;"><span>     StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">while</span> ((temp <span style="color:#f92672">=</span> br.<span style="color:#a6e22e">readLine</span>()) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         sb.<span style="color:#a6e22e">append</span>(temp);
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     resultMap.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;responseSoap&#34;</span>, sb.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span> } <span style="color:#66d9ef">catch</span> (UnsupportedEncodingException e) {
</span></span><span style="display:flex;"><span>     log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;获取请求返回报文失败,不支持的编码异常&#34;</span>,e);
</span></span><span style="display:flex;"><span> } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>     log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;获取请求返回报文失败,I/O异常&#34;</span>,e);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="问题4socketinputstream报错">问题4、SocketInputStream报错</h2>
<p><strong>具体描述</strong></p>
<p>排查到报错在<code>statusCode = httpClient.executeMethod(postMethod);</code>这一句，怀疑是要下载的xml文件过大（&gt;40M），导致<code>socketRead0</code>问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-prolog" data-lang="prolog"><span style="display:flex;"><span> <span style="color:#ae81ff">15</span><span style="color:#f92672">-</span>Jul<span style="color:#f92672">-</span><span style="color:#ae81ff">2020</span> <span style="color:#ae81ff">10</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">01</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">47.926</span> <span style="color:#e6db74">警告</span> [<span style="color:#e6db74">localhost</span><span style="color:#f92672">-</span><span style="color:#e6db74">startStop</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>] <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">catalina</span>.<span style="color:#e6db74">loader</span>.WebappClassLoaderBase.<span style="color:#e6db74">clearReferencesThreads</span> Web应用程序[<span style="color:#e6db74">imp</span><span style="color:#f92672">-</span><span style="color:#e6db74">ws</span>]<span style="color:#e6db74">似乎启动了一个名为</span>[<span style="color:#e6db74">pool</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#e6db74">thread</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#e6db74">的线程，但未能停止它。这很可能会造成内存泄漏。线程的堆栈跟踪：</span>[
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">net</span>.SocketInputStream.<span style="color:#a6e22e">socketRead0</span>(Native Method)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">net</span>.SocketInputStream.<span style="color:#a6e22e">socketRead</span>(Unknown Source)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">net</span>.SocketInputStream.<span style="color:#a6e22e">read</span>(Unknown Source)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">net</span>.SocketInputStream.<span style="color:#a6e22e">read</span>(Unknown Source)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">io</span>.BufferedInputStream.<span style="color:#a6e22e">fill</span>(Unknown Source)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">java</span>.<span style="color:#e6db74">io</span>.BufferedInputStream.<span style="color:#a6e22e">read</span>(Unknown Source)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpParser.<span style="color:#a6e22e">readRawLine</span>(HttpParser.java:<span style="color:#ae81ff">78</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpParser.<span style="color:#a6e22e">readLine</span>(HttpParser.java:<span style="color:#ae81ff">106</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpConnection.<span style="color:#a6e22e">readLine</span>(HttpConnection.java:<span style="color:#ae81ff">1116</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpMethodBase.<span style="color:#a6e22e">readStatusLine</span>(HttpMethodBase.java:<span style="color:#ae81ff">1973</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpMethodBase.<span style="color:#a6e22e">readResponse</span>(HttpMethodBase.java:<span style="color:#ae81ff">1735</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpMethodBase.<span style="color:#a6e22e">execute</span>(HttpMethodBase.java:<span style="color:#ae81ff">1098</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpMethodDirector.<span style="color:#a6e22e">executeWithRetry</span>(HttpMethodDirector.java:<span style="color:#ae81ff">398</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpMethodDirector.<span style="color:#a6e22e">executeMethod</span>(HttpMethodDirector.java:<span style="color:#ae81ff">171</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpClient.<span style="color:#a6e22e">executeMethod</span>(HttpClient.java:<span style="color:#ae81ff">397</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">commons</span>.<span style="color:#e6db74">httpclient</span>.HttpClient.<span style="color:#a6e22e">executeMethod</span>(HttpClient.java:<span style="color:#ae81ff">323</span>)
</span></span></code></pre></div><p><strong>解决方案和原理</strong></p>
<ol>
<li>对连接时间和读取时间的超时设置长些，2. 指定通过webservice获取的xml文件的条件，限定到具体的天，使得xml文件的内容变少。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">// 1. 超时时间设置</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> statusCode <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// 连接超时</span>
</span></span><span style="display:flex;"><span>     httpClient.<span style="color:#a6e22e">getHttpConnectionManager</span>().<span style="color:#a6e22e">getParams</span>().<span style="color:#a6e22e">setConnectionTimeout</span>(60000);
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// 读取超时</span>
</span></span><span style="display:flex;"><span>     httpClient.<span style="color:#a6e22e">getHttpConnectionManager</span>().<span style="color:#a6e22e">getParams</span>().<span style="color:#a6e22e">setSoTimeout</span>(60000);
</span></span><span style="display:flex;"><span>     statusCode <span style="color:#f92672">=</span> httpClient.<span style="color:#a6e22e">executeMethod</span>(postMethod);
</span></span><span style="display:flex;"><span>     resultMap.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;statusCode&#34;</span>, statusCode);
</span></span><span style="display:flex;"><span> } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>     e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// 2. webservice请求头条件</span>
</span></span><span style="display:flex;"><span> soap.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;        &lt;soa:AllConditions&gt;\\n&#34;</span>);
</span></span><span style="display:flex;"><span> soap.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;          &lt;Condition&gt;\\n&#34;</span>);
</span></span><span style="display:flex;"><span> condition.<span style="color:#a6e22e">accept</span>(soap);
</span></span><span style="display:flex;"><span> soap.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;          &lt;/Condition&gt;\\n&#34;</span>);
</span></span><span style="display:flex;"><span> soap.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;        &lt;/soa:AllConditions&gt;\\n&#34;</span>);
</span></span></code></pre></div><h2 id="问题5springboot项目在服务器上启动非常慢">问题5、springboot项目在服务器上启动非常慢</h2>
<p><strong>具体描述</strong></p>
<p>在本地调试的时候druiddatasource启动之后，在requestmap日志出来之前要卡很久，</p>
<p><img src="/images/image-20210410191450018.png" alt="image-20210410191450018"></p>
<p><strong>解决方案和原理</strong></p>
<p>结合之前丢服务器的tomcat上有mapper报错的问题，比对mapper泛型里的实体，发现实体和数据库的字段有个没有对上，导致出现了这个问题，注释掉多出来的字段就行。</p>
<h2 id="问题6spring-bean名称重复">问题6、spring bean名称重复</h2>
<p><strong>具体描述</strong></p>
<p>根据报错可以知道，cameraServiceImpl的名称重复了，generate文件夹和customize文件夹下都有这个</p>
<pre tabindex="0"><code>Caused by: org.springframework.context.annotation.ConflictingBeanDefinitionException: Annotation-specified bean name &#39;cameraServiceImpl&#39; for bean class [com.nrec.pcs9000.app.service.generate.impl.CameraServiceImpl] conflicts with existing, non-compatible bean definition of same name and class [com.nrec.pcs9000.app.service.customize.impl.CameraServiceImpl]
</code></pre><p><strong>解决方案和原理</strong></p>
<p>修改bean的名字即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;customCameraServiceImpl&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CameraServiceImpl</span> <span style="color:#66d9ef">implements</span> CameraService {
</span></span></code></pre></div><h2 id="问题7stringredistemplate-根据key前缀批量删除key">问题7、StringRedisTemplate 根据key前缀批量删除key</h2>
<ol>
<li>
<p>根据指定的key前缀 + &ldquo;<em>&quot;（</em> 号一定要有），查询出所有匹配到的key</p>
</li>
<li>
<p>调用StringRedisTemplate 的 delete 方法，把当前获取到的指定前缀key的<a href="https://so.csdn.net/so/search?q=%E9%9B%86%E5%90%88&amp;spm=1001.2101.3001.7020">集合</a>传进去</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> keys <span style="color:#f92672">=</span> stringKeyRedisTemplate.<span style="color:#a6e22e">keys</span>(keyType <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;*&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> keys <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        Long delete <span style="color:#f92672">=</span> stringKeyRedisTemplate.<span style="color:#a6e22e">delete</span>(keys);
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;取消【{}】类型的所有的守望位缓存共【{}】个&#34;</span>, keyType, delete);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> delete;
</span></span></code></pre></div><h2 id="问题8string像log一样用填充">问题8、String像log一样用{}填充</h2>
<p>hutool的strUtil已有实现，StrUtil.format，具体可以参照hutool文档</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (oldKeepWatch <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">build</span>(keepWatchService.<span style="color:#a6e22e">insert</span>(keepWatch),
</span></span><span style="display:flex;"><span>                    StrUtil.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;【{}】变电站【{}】下监控点【{}】主站守望位&#34;</span>, <span style="color:#e6db74">&#34;新增&#34;</span>, camera.<span style="color:#a6e22e">getRegion</span>(), camera.<span style="color:#a6e22e">getCamera</span>())
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (keepWatch.<span style="color:#a6e22e">getEnable</span>().<span style="color:#a6e22e">equals</span>(0)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">build</span>(keepWatchService.<span style="color:#a6e22e">updateById</span>(keepWatch),
</span></span><span style="display:flex;"><span>                    StrUtil.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;【{}】变电站【{}】下监控点【{}】主站守望位&#34;</span>, <span style="color:#e6db74">&#34;关闭&#34;</span>, camera.<span style="color:#a6e22e">getRegion</span>(), camera.<span style="color:#a6e22e">getCamera</span>())
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">build</span>(keepWatchService.<span style="color:#a6e22e">updateById</span>(keepWatch),
</span></span><span style="display:flex;"><span>                    StrUtil.<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;【{}】变电站【{}】下监控点【{}】主站守望位&#34;</span>, <span style="color:#e6db74">&#34;修改&#34;</span>, camera.<span style="color:#a6e22e">getRegion</span>(), camera.<span style="color:#a6e22e">getCamera</span>())
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><h2 id="问题9通过反射将map转为实体并且获取service实现入库">问题9、通过反射将Map转为实体并且获取service实现入库</h2>
<p>利用Hutool的反射工具类 ReflectUtil 获取service，和实体工具类 BeanUtil 转化map为Bean</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span>() <span style="color:#66d9ef">throws</span> ClassNotFoundException {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1、读取excel读取为Map列表，默认第一行为标题行，Map中的key为标题，value为标题对应的单元格值；</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2、从数据库把配置数据读取出来，步骤1中的数据，把map中的中文标题key转为英文字段key；</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;&gt;</span> mapList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> objMap1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        objMap1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;indexCode&#34;</span>, <span style="color:#e6db74">&#34;111&#34;</span>);
</span></span><span style="display:flex;"><span>        objMap1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;preset&#34;</span>,1);
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> objMap2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        objMap2.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;indexCode&#34;</span>, <span style="color:#e6db74">&#34;222&#34;</span>);
</span></span><span style="display:flex;"><span>        objMap2.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;preset&#34;</span>,2);
</span></span><span style="display:flex;"><span>        mapList.<span style="color:#a6e22e">add</span>(objMap1);
</span></span><span style="display:flex;"><span>        mapList.<span style="color:#a6e22e">add</span>(objMap2);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3、步骤2转化后的Map列表，根据表名，通过反射转为对应的entity列表；</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#f92672">&lt;?&gt;</span> entityClass <span style="color:#f92672">=</span> Class.<span style="color:#a6e22e">forName</span>(<span style="color:#e6db74">&#34;com.nrec.pcs9000.app.entity.CameraKeepWatch&#34;</span>);
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> entityList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map : mapList) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Object o = BeanUtil.fillBeanWithMap(map, entityClass.newInstance(), true);</span>
</span></span><span style="display:flex;"><span>            Object entity <span style="color:#f92672">=</span> BeanUtil.<span style="color:#a6e22e">toBean</span>(map, entityClass);
</span></span><span style="display:flex;"><span>            entityList.<span style="color:#a6e22e">add</span>(entity);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4、根据表名，反射获取对应的serviceImpl，实现entity列表入库</span>
</span></span><span style="display:flex;"><span>        Object beanService <span style="color:#f92672">=</span> SpringUtil.<span style="color:#a6e22e">getBean</span>(<span style="color:#e6db74">&#34;cameraKeepWatchServiceImpl&#34;</span>);
</span></span><span style="display:flex;"><span>        ReflectUtil.<span style="color:#a6e22e">invoke</span>(beanService, <span style="color:#e6db74">&#34;insertOrUpdateBatch&#34;</span>, entityList);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="问题10java泛型中etkv等含义">问题10、Java泛型中E、T、K、V等含义</h2>
<p><strong>Java泛型中的标记符含义：</strong></p>
<p><strong>E</strong> - Element (在集合中使用，因为集合中存放的是元素)</p>
<p><strong>T</strong> - Type（Java 类）</p>
<p><strong>K</strong> - Key（键）</p>
<p><strong>V</strong> - Value（值）</p>
<p><strong>N</strong> - Number（数值类型）</p>
<p><strong>？</strong> - 表示不确定的java类型</p>
<p><strong>S、U、V</strong> - 2nd、3rd、4th types</p>
<h2 id="问题12dom4j解析xml已发布">问题12、dom4j解析xml【已发布】</h2>
<p>dom4j获取iterator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @author luohao
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @create 2020/6/18 17:21
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dom4jUtils</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getElementIterator</span>(String path) {
</span></span><span style="display:flex;"><span>         SAXReader reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SAXReader();
</span></span><span style="display:flex;"><span>         Document document <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>             document <span style="color:#f92672">=</span> reader.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">new</span> File(path));
</span></span><span style="display:flex;"><span>         } <span style="color:#66d9ef">catch</span> (DocumentException e) {
</span></span><span style="display:flex;"><span>             log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Dom4j：读取xml文件时异常{}&#34;</span>, e.<span style="color:#a6e22e">getMessage</span>(), e);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>         Optional<span style="color:#f92672">&lt;</span>Document<span style="color:#f92672">&gt;</span> docElementOpt <span style="color:#f92672">=</span> Optional.<span style="color:#a6e22e">ofNullable</span>(document);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> docElementOpt.<span style="color:#a6e22e">map</span>(Document::getRootElement).<span style="color:#a6e22e">map</span>(Element::elementIterator).<span style="color:#a6e22e">orElseGet</span>(() <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span>() {
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span>() {
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">public</span> Element <span style="color:#a6e22e">next</span>() {
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>         });
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>获取xml的node节点和属性</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      * @param path  文件路径
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      * @param list  用于基本信息表的数据list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      * @param list1 用于详细信息表的数据list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">extractXml</span>(String path, List<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;&gt;</span> list, List<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;&gt;</span> list1) {
</span></span><span style="display:flex;"><span>         Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> it <span style="color:#f92672">=</span> Dom4jUtils.<span style="color:#a6e22e">getElementIterator</span>(path);
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 遍历迭代器，获取根节点中的信息（书籍）</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">while</span> (it.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>             Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 存放一个主键</span>
</span></span><span style="display:flex;"><span>             String stationNameVal <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>             String checkTimeVal <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>             Element node <span style="color:#f92672">=</span> it.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 塞入巡检报告基本信息表（IFR_CHECKREPORT_BASEINFO）</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;System&#34;</span>.<span style="color:#a6e22e">equals</span>(node.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                 <span style="color:#75715e">// 迭代一次</span>
</span></span><span style="display:flex;"><span>                 Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> itt <span style="color:#f92672">=</span> node.<span style="color:#a6e22e">elementIterator</span>();
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">while</span> (itt.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>                     Element nodeChild <span style="color:#f92672">=</span> itt.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">// 转换substation的key</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;Substation&#34;</span>.<span style="color:#a6e22e">equals</span>(nodeChild.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                         map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;StationName&#34;</span>, nodeChild.<span style="color:#a6e22e">getStringValue</span>());
</span></span><span style="display:flex;"><span>                         stationNameVal <span style="color:#f92672">=</span> nodeChild.<span style="color:#a6e22e">getStringValue</span>();
</span></span><span style="display:flex;"><span>                     } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;CheckTime&#34;</span>.<span style="color:#a6e22e">equals</span>(nodeChild.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                         map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;CheckTime&#34;</span>, nodeChild.<span style="color:#a6e22e">getStringValue</span>());
</span></span><span style="display:flex;"><span>                         checkTimeVal <span style="color:#f92672">=</span> nodeChild.<span style="color:#a6e22e">getStringValue</span>();
</span></span><span style="display:flex;"><span>                     } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                         map.<span style="color:#a6e22e">put</span>(nodeChild.<span style="color:#a6e22e">getName</span>(), nodeChild.<span style="color:#a6e22e">getStringValue</span>());
</span></span><span style="display:flex;"><span>                     }
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 塞入巡检报告概要结果表（IFR_CHECKREPORT_DETAILINFO）</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;Ied&#34;</span>.<span style="color:#a6e22e">equals</span>(node.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                 <span style="color:#75715e">// 迭代两次</span>
</span></span><span style="display:flex;"><span>                 Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> itt <span style="color:#f92672">=</span> node.<span style="color:#a6e22e">elementIterator</span>();
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">while</span> (itt.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>                     Element nodeChild <span style="color:#f92672">=</span> itt.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>                     Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">// 在map1里边存入一个主键</span>
</span></span><span style="display:flex;"><span>                     map1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;StationName&#34;</span>, stationNameVal);
</span></span><span style="display:flex;"><span>                     map1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;CheckTime&#34;</span>, checkTimeVal);
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">// 获取nodeChild的attrs</span>
</span></span><span style="display:flex;"><span>                     List<span style="color:#f92672">&lt;</span>Attribute<span style="color:#f92672">&gt;</span> attrs <span style="color:#f92672">=</span> nodeChild.<span style="color:#a6e22e">attributes</span>();
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">for</span> (Attribute attr : attrs) {
</span></span><span style="display:flex;"><span>                         <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;IsChecked&#34;</span>.<span style="color:#a6e22e">equals</span>(attr.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                             map1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;DeviceIsChecked&#34;</span>, attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                         } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;UnCheckedReason&#34;</span>.<span style="color:#a6e22e">equals</span>(attr.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                             map1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;DeviceUnCheckReason&#34;</span>, attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                         } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;result&#34;</span>.<span style="color:#a6e22e">equals</span>(attr.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                             map1.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;DeviceResult&#34;</span>, attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                         } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                             map1.<span style="color:#a6e22e">put</span>(attr.<span style="color:#a6e22e">getName</span>(), attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                         }
</span></span><span style="display:flex;"><span>                     }
</span></span><span style="display:flex;"><span>                     Iterator<span style="color:#f92672">&lt;</span>Element<span style="color:#f92672">&gt;</span> ittt <span style="color:#f92672">=</span> nodeChild.<span style="color:#a6e22e">elementIterator</span>();
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">while</span> (ittt.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>                         Element nodeChild1 <span style="color:#f92672">=</span> ittt.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>                         <span style="color:#75715e">// 获取nodeChild1的attrs</span>
</span></span><span style="display:flex;"><span>                         List<span style="color:#f92672">&lt;</span>Attribute<span style="color:#f92672">&gt;</span> attrs1 <span style="color:#f92672">=</span> nodeChild1.<span style="color:#a6e22e">attributes</span>();
</span></span><span style="display:flex;"><span>                         <span style="color:#66d9ef">for</span> (Attribute attr : attrs1) {
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;result&#34;</span>.<span style="color:#a6e22e">equals</span>(attr.<span style="color:#a6e22e">getName</span>())) {
</span></span><span style="display:flex;"><span>                                 map1.<span style="color:#a6e22e">put</span>(nodeChild1.<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;Result&#34;</span>, attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                             } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                                 map1.<span style="color:#a6e22e">put</span>(nodeChild1.<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> attr.<span style="color:#a6e22e">getName</span>(), attr.<span style="color:#a6e22e">getValue</span>());
</span></span><span style="display:flex;"><span>                             }
</span></span><span style="display:flex;"><span>                         }
</span></span><span style="display:flex;"><span>                     }
</span></span><span style="display:flex;"><span>                     list1.<span style="color:#a6e22e">add</span>(map1);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>             } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                 <span style="color:#75715e">// 详细报告不录入，之后再改</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (map.<span style="color:#a6e22e">size</span>() <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>                 list.<span style="color:#a6e22e">add</span>(map);
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><h2 id="问题13map和bean互转已发布">问题13、map和bean互转【已发布】</h2>
<p><strong>Map转为Bean</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T, K, V<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">map2Bean</span>(Map<span style="color:#f92672">&lt;</span>K, V<span style="color:#f92672">&gt;</span> map, Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> beanCls) {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// try catch未写</span>
</span></span><span style="display:flex;"><span>     T t <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>     BeanInfo beanInfo <span style="color:#f92672">=</span> Introspector.<span style="color:#a6e22e">getBeanInfo</span>(beanCls.<span style="color:#a6e22e">getClass</span>());
</span></span><span style="display:flex;"><span>     PropertyDescriptor<span style="color:#f92672">[]</span> propertyDescriptors <span style="color:#f92672">=</span> beanInfo.<span style="color:#a6e22e">getPropertyDescriptors</span>();
</span></span><span style="display:flex;"><span>     t <span style="color:#f92672">=</span> beanCls.<span style="color:#a6e22e">newInstance</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">for</span> (PropertyDescriptor property : propertyDescriptors) {
</span></span><span style="display:flex;"><span>         String key <span style="color:#f92672">=</span> property.<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (map.<span style="color:#a6e22e">containsKey</span>(key)) {
</span></span><span style="display:flex;"><span>             Object value <span style="color:#f92672">=</span> map.<span style="color:#a6e22e">get</span>(key);
</span></span><span style="display:flex;"><span>             Method setter <span style="color:#f92672">=</span> property.<span style="color:#a6e22e">getWriteMethod</span>();
</span></span><span style="display:flex;"><span>             setter.<span style="color:#a6e22e">invoke</span>(t, value);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> t;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p><strong>Bean转为Map</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T, K, V<span style="color:#f92672">&gt;</span> Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">bean2Map</span>(T bean) {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// try catch未写</span>
</span></span><span style="display:flex;"><span>     Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (bean <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     BeanInfo beanInfo <span style="color:#f92672">=</span> Introspector.<span style="color:#a6e22e">getBeanInfo</span>(bean.<span style="color:#a6e22e">getClass</span>());
</span></span><span style="display:flex;"><span>     PropertyDescriptor<span style="color:#f92672">[]</span> propertyDescriptors <span style="color:#f92672">=</span> beanInfo.<span style="color:#a6e22e">getPropertyDescriptors</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">for</span> (PropertyDescriptor property : propertyDescriptors) {
</span></span><span style="display:flex;"><span>         String key <span style="color:#f92672">=</span> property.<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#e6db74">&#34;class&#34;</span>.<span style="color:#a6e22e">equalsIgnoreCase</span>(key)) {
</span></span><span style="display:flex;"><span>             Method getter <span style="color:#f92672">=</span> property.<span style="color:#a6e22e">getReadMethod</span>();
</span></span><span style="display:flex;"><span>             Object value <span style="color:#f92672">=</span> getter.<span style="color:#a6e22e">invoke</span>(bean);
</span></span><span style="display:flex;"><span>             map.<span style="color:#a6e22e">put</span>(key, value);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> map;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="问题14创建不可变并且static静态集合已发布">问题14、创建不可变并且static静态集合【已发布】</h2>
<p><strong>findbugs错误提示</strong></p>
<p>MS_MUTABLE_COLLECTION_PKGPROTECT, Priority: Normal</p>
<p>XX.XX.XXX.XX is a mutable collection which should be package protected</p>
<pre tabindex="0"><code> A mutable collection instance is assigned to a final static field, thus can be changed by malicious code or by accident from another package. The field could be made package protected to avoid this vulnerability. Alternatively you may wrap this field into Collections.unmodifiableSet/List/Map/etc. to avoid this vulnerability.
</code></pre><p><strong>很容易写的一个错误案例如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMap</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>Integer,String<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashMap<span style="color:#f92672">&lt;</span>Integer, String<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>     map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>     map.<span style="color:#a6e22e">put</span>(1, <span style="color:#e6db74">&#34;one&#34;</span>);
</span></span><span style="display:flex;"><span>     map.<span style="color:#a6e22e">put</span>(2, <span style="color:#e6db74">&#34;two&#34;</span>);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p><strong>正确的做法 ，通过Collections.unmodifiableMap。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMap</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>Integer,String<span style="color:#f92672">&gt;</span> map ;
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>     Map<span style="color:#f92672">&lt;</span>Integer,String<span style="color:#f92672">&gt;</span> tempMap  <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>     tempMap.<span style="color:#a6e22e">put</span>(1, <span style="color:#e6db74">&#34;one&#34;</span>);
</span></span><span style="display:flex;"><span>     tempMap.<span style="color:#a6e22e">put</span>(2, <span style="color:#e6db74">&#34;two&#34;</span>);
</span></span><span style="display:flex;"><span>     map <span style="color:#f92672">=</span> Collections.<span style="color:#a6e22e">unmodifiableMap</span>(tempMap);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>如果现在往map里添加元素，则抛出UnsupportedOperationException异常</p>
<h2 id="问题15实现文件监听">问题15、实现文件监听</h2>
<p>hutool有具体实现</p>
<ul>
<li>支持多级目录的监听（WatchService只支持一级目录），可自定义监听目录深度</li>
<li>延迟合并触发支持（文件变动时可能触发多次modify，支持在某个时间范围内的多次修改事件合并为一个修改事件）</li>
<li>简洁易懂的API方法，一个方法即可搞定监听，无需理解复杂的监听注册机制。</li>
<li>多观察者实现，可以根据业务实现多个<code>Watcher</code>来响应同一个事件（通过WatcherChain）</li>
</ul>
<p><strong>监听指定事件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File file <span style="color:#f92672">=</span> FileUtil.<span style="color:#a6e22e">file</span>(<span style="color:#e6db74">&#34;example.properties&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//这里只监听文件或目录的修改事件</span>
</span></span><span style="display:flex;"><span>WatchMonitor watchMonitor <span style="color:#f92672">=</span> WatchMonitor.<span style="color:#a6e22e">create</span>(file, WatchMonitor.<span style="color:#a6e22e">ENTRY_MODIFY</span>);
</span></span><span style="display:flex;"><span>watchMonitor.<span style="color:#a6e22e">setWatcher</span>(<span style="color:#66d9ef">new</span> Watcher(){
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//设置监听目录的最大深入，目录层级大于制定层级的变更将不被监听，默认只监听当前层级目录</span>
</span></span><span style="display:flex;"><span>watchMonitor.<span style="color:#a6e22e">setMaxDepth</span>(3);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//启动监听</span>
</span></span><span style="display:flex;"><span>watchMonitor.<span style="color:#a6e22e">start</span>();
</span></span></code></pre></div><p><strong>监听全部事件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>WatchMonitor.<span style="color:#a6e22e">createAll</span>(file, <span style="color:#66d9ef">new</span> SimpleWatcher(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onModify</span>(WatchEvent<span style="color:#f92672">&lt;?&gt;</span> event, Path currentPath) {
</span></span><span style="display:flex;"><span>        Console.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;EVENT modify&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}).<span style="color:#a6e22e">start</span>();
</span></span></code></pre></div><p><strong>延迟处理监听事件</strong></p>
<p>在监听目录或文件时，如果这个文件有修改操作，JDK会多次触发modify方法，为了解决这个问题，我们定义了<code>DelayWatcher</code>，此类通过维护一个Set将短时间内相同文件多次modify的事件合并处理触发，从而避免以上问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>WatchMonitor monitor <span style="color:#f92672">=</span> WatchMonitor.<span style="color:#a6e22e">createAll</span>(<span style="color:#e6db74">&#34;d:/&#34;</span>, <span style="color:#66d9ef">new</span> DelayWatcher(watcher, 500));
</span></span><span style="display:flex;"><span>monitor.<span style="color:#a6e22e">start</span>();
</span></span></code></pre></div><h2 id="问题16各时间类的转换已发布">问题16、各时间类的转换【已发布】</h2>
<p><strong>LocalDateTime和Long的转换</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>fun <span style="color:#a6e22e">transform</span>() {
</span></span><span style="display:flex;"><span>        val localDateTime <span style="color:#f92672">=</span> LocalDateTime.<span style="color:#a6e22e">now</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// LocalDateTime to LocalDate</span>
</span></span><span style="display:flex;"><span>        println(localDateTime.<span style="color:#a6e22e">toLocalDate</span>())
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// LocalDateTime to Instant</span>
</span></span><span style="display:flex;"><span>        println(localDateTime.<span style="color:#a6e22e">toInstant</span>(ZoneOffset.<span style="color:#a6e22e">UTC</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        LocalDateTime to Long</span>
</span></span><span style="display:flex;"><span>        println(localDateTime.<span style="color:#a6e22e">toInstant</span>(ZoneOffset.<span style="color:#a6e22e">UTC</span>).<span style="color:#a6e22e">toEpochMilli</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        val localDate <span style="color:#f92672">=</span> LocalDate.<span style="color:#a6e22e">now</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// LocalDate to LocalDateTime</span>
</span></span><span style="display:flex;"><span>        println(localDate.<span style="color:#a6e22e">atTime</span>(LocalTime.<span style="color:#a6e22e">now</span>()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        LocalDate to Instant</span>
</span></span><span style="display:flex;"><span>        println(localDate.<span style="color:#a6e22e">atTime</span>(LocalTime.<span style="color:#a6e22e">now</span>()).<span style="color:#a6e22e">toInstant</span>(ZoneOffset.<span style="color:#a6e22e">UTC</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        LocalDate to Long</span>
</span></span><span style="display:flex;"><span>        println(localDate.<span style="color:#a6e22e">atTime</span>(LocalTime.<span style="color:#a6e22e">now</span>()).<span style="color:#a6e22e">toInstant</span>(ZoneOffset.<span style="color:#a6e22e">UTC</span>).<span style="color:#a6e22e">toEpochMilli</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        val instant <span style="color:#f92672">=</span> Instant.<span style="color:#a6e22e">now</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Instant to LocalDateTime</span>
</span></span><span style="display:flex;"><span>        println(LocalDateTime.<span style="color:#a6e22e">ofInstant</span>(instant, ZoneId.<span style="color:#a6e22e">systemDefault</span>()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Instant to LocalDate</span>
</span></span><span style="display:flex;"><span>        println(LocalDate.<span style="color:#a6e22e">ofInstant</span>(instant, ZoneId.<span style="color:#a6e22e">systemDefault</span>()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Instant to Long</span>
</span></span><span style="display:flex;"><span>        println(instant.<span style="color:#a6e22e">toEpochMilli</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        val milli: Long <span style="color:#f92672">=</span> Instant.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">toEpochMilli</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Long to LocalDateTime</span>
</span></span><span style="display:flex;"><span>        println(LocalDateTime.<span style="color:#a6e22e">ofInstant</span>(Instant.<span style="color:#a6e22e">ofEpochMilli</span>(milli), ZoneId.<span style="color:#a6e22e">systemDefault</span>()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Long to LocalDate</span>
</span></span><span style="display:flex;"><span>        println(LocalDate.<span style="color:#a6e22e">ofInstant</span>(Instant.<span style="color:#a6e22e">ofEpochMilli</span>(milli), ZoneId.<span style="color:#a6e22e">systemDefault</span>()))
</span></span><span style="display:flex;"><span><span style="color:#75715e">//        Long to Instant</span>
</span></span><span style="display:flex;"><span>        println(Instant.<span style="color:#a6e22e">ofEpochMilli</span>(milli))
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><strong>LocalDateTime和String的转换</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// LocalDateTime转为String</span>
</span></span><span style="display:flex;"><span>String string <span style="color:#f92672">=</span> LocalDateTime.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">format</span>(<span style="color:#66d9ef">new</span> DateTimeFormatter.<span style="color:#a6e22e">ofPattern</span>(<span style="color:#e6db74">&#34;yyyy-MM-dd HH:mm:ss.SSSSSS&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#75715e">// String转为LocalDateTime</span>
</span></span><span style="display:flex;"><span>String time <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2020-07-08 14:41:50.238473&#34;</span>;
</span></span><span style="display:flex;"><span>LocalDateTime parse <span style="color:#f92672">=</span> LocalDateTime.<span style="color:#a6e22e">parse</span>(time, <span style="color:#66d9ef">new</span> DateTimeFormatter.<span style="color:#a6e22e">ofPattern</span>(<span style="color:#e6db74">&#34;yyyy-MM-dd HH:mm:ss.SSSSSS&#34;</span>));
</span></span></code></pre></div><p><strong>java.util.Date和String的转换</strong></p>
<p>SimpleDateFormat格式化进行转换</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">// java.util.Date转换String</span>
</span></span><span style="display:flex;"><span> DateFormat dateFormat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleDateFormat(<span style="color:#e6db74">&#34;dd-MM-yy:HH:mm:ss&#34;</span>);
</span></span><span style="display:flex;"><span> Date date <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span> String dateStr <span style="color:#f92672">=</span> dateFormat.<span style="color:#a6e22e">format</span>(date);
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// String转换java.util.Date</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>     DateFormat dateFormat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleDateFormat(<span style="color:#e6db74">&#34;dd/MM/yyy&#34;</span>);
</span></span><span style="display:flex;"><span>     Date date <span style="color:#f92672">=</span> dateFormat.<span style="color:#a6e22e">parse</span>(dateStr);
</span></span><span style="display:flex;"><span> } <span style="color:#66d9ef">catch</span> (ParseException e) {
</span></span><span style="display:flex;"><span>     e.<span style="color:#a6e22e">printStack</span>();
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p><strong>java.sql.Timestamp和String的转换</strong></p>
<p>与java.util.Date和String的转换类似，都是通过SimpleDateFormat格式化进行转换，不展开代码细讲。</p>
<p><strong>java.util.Date和java.sql.Timestamp的转换</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">//Date转换Timestamp</span>
</span></span><span style="display:flex;"><span> Timestamp timestamp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timestamp((<span style="color:#66d9ef">new</span> Date()).<span style="color:#a6e22e">getTime</span>());
</span></span><span style="display:flex;"><span> <span style="color:#75715e">//Timestamp转换Date，二者是父子关系，可以直接赋值，自动转换</span>
</span></span><span style="display:flex;"><span> Timestamp timestamp1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timestamp(System.<span style="color:#a6e22e">currentTimeMillis</span>());
</span></span><span style="display:flex;"><span> Date date <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date(timestamp1.<span style="color:#a6e22e">getTime</span>());
</span></span></code></pre></div><p><strong>timestamp的比较</strong></p>
<p><code>before</code>和<code>after</code>函数，可以参考源码内的实现，<code>compareTo</code>接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> Timestamp a <span style="color:#f92672">=</span> Timestamp.<span style="color:#a6e22e">valueOf</span>(<span style="color:#e6db74">&#34;2018-05-18 09:32:32&#34;</span>);
</span></span><span style="display:flex;"><span> Timestamp b <span style="color:#f92672">=</span> Timestamp.<span style="color:#a6e22e">valueOf</span>(<span style="color:#e6db74">&#34;2018-05-11 09:32:32&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> (b.<span style="color:#a6e22e">before</span>(a)) {
</span></span><span style="display:flex;"><span>     System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;b时间比a时间早&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>before函数中封装了compareTo函数，在<code>compareTo(Timestamp t)</code>中对传入的Timestamp做比较。通过<code>long thisTime = this.getTime();</code>获取的时间戳进行比较，<code>compareTo(Date u)</code>也可以传入java.util.Date，不过也是对其做Timestamp的转换后调用<code>compareTo(Timestamp t)</code>做的处理。</p>
<h2 id="问题17打包资源文件压缩不可用">问题17、打包资源文件压缩不可用</h2>
<p><strong>1、获取文件流</strong></p>
<p>获取来自IDEA的项目resources目录下的defect-template.docx这个word文件模板，并且生成word</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">generateWord</span>(File file, List<span style="color:#f92672">&lt;</span>PatrolDefectDto<span style="color:#f92672">&gt;</span> list, HashMap<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> headerMap) <span style="color:#66d9ef">throws</span> UnsupportedEncodingException {
</span></span><span style="display:flex;"><span>        Resource docxRes <span style="color:#f92672">=</span> resourceLoader.<span style="color:#a6e22e">getResource</span>(<span style="color:#e6db74">&#34;classpath:defect-template.docx&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 表格主体</span>
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;&gt;</span> tables <span style="color:#f92672">=</span> getTables(list);
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> paramMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>(headerMap);
</span></span><span style="display:flex;"><span>        paramMap.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;tables&#34;</span>, tables);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            XWPFTemplate.<span style="color:#a6e22e">compile</span>(docxRes.<span style="color:#a6e22e">getInputStream</span>()).<span style="color:#a6e22e">render</span>(paramMap).<span style="color:#a6e22e">writeToFile</span>(file.<span style="color:#a6e22e">getAbsolutePath</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String fileFinish <span style="color:#f92672">=</span> file.<span style="color:#a6e22e">getAbsolutePath</span>().<span style="color:#a6e22e">replace</span>(<span style="color:#e6db74">&#34;start&#34;</span>, <span style="color:#e6db74">&#34;finished&#34;</span>);
</span></span><span style="display:flex;"><span>        file.<span style="color:#a6e22e">renameTo</span>(<span style="color:#66d9ef">new</span> File(fileFinish));
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p><strong>2、压缩文件过滤</strong></p>
<p>如果把压缩好的war包/jar包解压缩，打开包里的word文件发现损坏，基本确定是maven install 打包的时候导致文件压缩不可用的原因了！只需要在pom中加入以下配置即可解决</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>2.6<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>maven-resources-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;encoding&gt;</span>UTF-8<span style="color:#f92672">&lt;/encoding&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;nonFilteredFileExtensions&gt;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&lt;nonFilteredFileExtension&gt;</span>docx<span style="color:#f92672">&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;/nonFilteredFileExtensions&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span></code></pre></div><h2 id="问题18数组拼接去除最后的分号">问题18、数组拼接去除最后的分号</h2>
<p>代码片段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> Arrays.<span style="color:#a6e22e">asList</span>(<span style="color:#e6db74">&#34;a&#34;</span>, <span style="color:#e6db74">&#34;b&#34;</span>, <span style="color:#e6db74">&#34;c&#34;</span>, <span style="color:#e6db74">&#34;d&#34;</span>, <span style="color:#e6db74">&#34;end&#34;</span>);
</span></span><span style="display:flex;"><span>        StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (String s : list) {
</span></span><span style="display:flex;"><span>            sb.<span style="color:#a6e22e">append</span>(s).<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">delete</span>(sb.<span style="color:#a6e22e">length</span>() <span style="color:#f92672">-</span> 1, sb.<span style="color:#a6e22e">length</span>());
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;StringBuilder的做法：&#34;</span> <span style="color:#f92672">+</span> sb);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Commons lang3的做法：&#34;</span> <span style="color:#f92672">+</span> StringUtils.<span style="color:#a6e22e">join</span>(list, <span style="color:#e6db74">&#34;,&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>输出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>StringBuilder的做法：a,b,c,d,end
</span></span><span style="display:flex;"><span>Commons lang3的做法：a,b,c,d,end
</span></span></code></pre></div><h2 id="问题19线程定时得到结果退出示例已发布">问题19、线程定时得到结果退出示例【已发布】</h2>
<p><strong>大致需求</strong></p>
<blockquote>
<p>定时每几秒调用一次rest接口，如果接口响应成功则退出线程，如果接口响应失败，则继续调用直至成功。</p>
</blockquote>
<p>做了一个简单的线程任务。简单来说是一个异步的调用方式。目前采用的方式是设置一个flag，作为判断rest接口是否调用成功的结果标志位，接口调用不成功则线程死循环；接口调用成功则线程不进入while，退出。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 线程沉睡时间，每3秒试图调用一次接口插入到告警表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> timeInterval <span style="color:#f92672">=</span> 3000;
</span></span><span style="display:flex;"><span>    AtomicBoolean flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicBoolean(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>    Thread thread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>flag.<span style="color:#a6e22e">get</span>()) {
</span></span><span style="display:flex;"><span>            flag.<span style="color:#a6e22e">set</span>(testFlag());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(timeInterval);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;thread sleep interrupted&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    thread.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">testFlag</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> code <span style="color:#f92672">=</span> 500;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> fl <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (code <span style="color:#f92672">==</span> 500) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (code <span style="color:#f92672">==</span> 200) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;code = 200，存入数据库&#34;</span>);
</span></span><span style="display:flex;"><span>            fl <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;未获得code&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> fl;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>Connected to the target VM, address: <span style="color:#ae81ff">&#39;1</span><span style="color:#ae81ff">27.0.0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">51619</span>&#39;, transport: &#39;socket&#39;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">38</span><span style="color:#f92672">:</span><span style="color:#ae81ff">56.445</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">未获得</span>code
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">38</span><span style="color:#f92672">:</span><span style="color:#ae81ff">59.450</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">未获得</span>code
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">39</span><span style="color:#f92672">:</span><span style="color:#ae81ff">02.451</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">未获得</span>code
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">39</span><span style="color:#f92672">:</span><span style="color:#ae81ff">05.452</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">未获得</span>code
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">39</span><span style="color:#f92672">:</span><span style="color:#ae81ff">08.453</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">未获得</span>code
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">39</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25.722</span> [Thread<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>] INFO com.nrec.pcs9000.app.<span style="color:#66d9ef">task</span>.RobotLinkageTask <span style="color:#f92672">-</span> code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span><span style="color:#960050;background-color:#1e0010">，存入数据库</span>
</span></span><span style="display:flex;"><span>Disconnected from the target VM, address: <span style="color:#ae81ff">&#39;1</span><span style="color:#ae81ff">27.0.0.1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">51619</span>&#39;, transport: &#39;socket&#39;
</span></span></code></pre></div><p><strong>需求升级</strong></p>
<p>在原有需求上考量，如果接口持续调用失败，那新开的线程则一直不会退出。一段时间内产生的线程要是足够多，说不定导致所有的线程不会退出，JVM宕机。因此在原有的基础上加一个固定的超时需求。</p>
<blockquote>
<p>定时每几秒调用一次rest接口，如果接口响应成功则退出线程，如果接口响应失败，则继续调用直至成功。如果接口响应一直失败，则在固定的时间内超时退出。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 线程沉睡时间，每6秒试图调用一次接口插入到告警表</span>
</span></span><span style="display:flex;"><span>ExecutorService executor <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newSingleThreadExecutor</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> timeInterval <span style="color:#f92672">=</span> 6000;
</span></span><span style="display:flex;"><span>AtomicBoolean flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicBoolean(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>Future<span style="color:#f92672">&lt;</span>Boolean<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> executor.<span style="color:#a6e22e">submit</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>flag.<span style="color:#a6e22e">get</span>()) {
</span></span><span style="display:flex;"><span>        flag.<span style="color:#a6e22e">set</span>(getAndInsertTaskPatrolledId(headerParameters, taskCode, stationCode));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#a6e22e">sleep</span>(timeInterval);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;线程中断，退出&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注意这里也是false，退出while之后线程也是结束的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;开始获取机器人任务运行状态&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 10分钟超时时间</span>
</span></span><span style="display:flex;"><span>    future.<span style="color:#a6e22e">get</span>(600, TimeUnit.<span style="color:#a6e22e">SECONDS</span>);
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;获取机器人任务运行状态成功，已存入数据库!&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (TimeoutException e) {
</span></span><span style="display:flex;"><span>    future.<span style="color:#a6e22e">cancel</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;线程超时结束!&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (InterruptedException <span style="color:#f92672">|</span> ExecutionException e) {
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>executor.<span style="color:#a6e22e">shutdownNow</span>();
</span></span></code></pre></div><h2 id="问题20关于日志配置">问题20、关于日志配置</h2>
<p><strong>slf4j-log4j12日志的种类</strong></p>
<p>Slf4j，log4j2，log4j，logging，logback等多种日志手段。</p>
<p><strong>Maven项目引入log4j2</strong></p>
<p><strong>1、普通Maven项目</strong></p>
<p><strong>pom.xml</strong></p>
<ol>
<li>单独引入日志</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>         <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;groupId&gt;</span>org.slf4j<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;artifactId&gt;</span>slf4j-log4j12<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;version&gt;</span>1.7.30<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol>
<li>引入日志门面，配合hutool工具集</li>
</ol>
<blockquote>
<p>Hutool-log对于日志框架的监测顺序是： Slf4j(Logback) &gt; Log4j &gt; Log4j2 &gt; Apache Commons Logging &gt; JDK Logging &gt; Console当然，如果只是引入Slf4j-API，而没有引入任何实现，Slf4j将被跳过。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>     <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;groupId&gt;</span>org.slf4j<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;artifactId&gt;</span>slf4j-log4j12<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;version&gt;</span>1.7.30<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;groupId&gt;</span>cn.hutool<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;artifactId&gt;</span>hutool-all<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;version&gt;</span>5.3.7<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>log4j.properties</strong></p>
<p>resources目录下log4j.properties</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-prolog" data-lang="prolog"><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">rootLogger</span><span style="color:#f92672">=</span>DEBUG,<span style="color:#e6db74">console</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span><span style="color:#f92672">=</span><span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">log4j</span>.ConsoleAppender
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span>.Threshold<span style="color:#f92672">=</span>DEBUG
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span>.ImmediateFlush<span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">#log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span>.Target<span style="color:#f92672">=</span>System.<span style="color:#e6db74">err</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span>.<span style="color:#e6db74">layout</span><span style="color:#f92672">=</span><span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">log4j</span>.PatternLayout
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.<span style="color:#e6db74">console</span>.<span style="color:#e6db74">layout</span>.ConversionPattern<span style="color:#f92672">=</span> <span style="color:#75715e">%-5p %d(%r) [%t] %c %L %M - %m%n</span>
</span></span></code></pre></div><p>或者可以</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-prolog" data-lang="prolog"><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">rootLogger</span><span style="color:#f92672">=</span><span style="color:#e6db74">debug</span>,STDOUT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">additivity</span>.<span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.STDOUT<span style="color:#f92672">=</span><span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">log4j</span>.ConsoleAppender
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.STDOUT.<span style="color:#e6db74">layout</span><span style="color:#f92672">=</span><span style="color:#e6db74">org</span>.<span style="color:#e6db74">apache</span>.<span style="color:#e6db74">log4j</span>.PatternLayout
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">log4j</span>.<span style="color:#e6db74">appender</span>.STDOUT.<span style="color:#e6db74">layout</span>.ConversionPattern<span style="color:#f92672">=</span>[<span style="color:#75715e">%d{HH:mm:ss,SSS}][%5p] %c:%L - %m%n</span>
</span></span></code></pre></div><p><strong>2、Spring boot的Maven项目</strong></p>
<ol>
<li>spring boot 本身有带logging日志</li>
</ol>
<p><a href="https://www.cnblogs.com/xishuai/p/spring-boot-log4j2.html">Spring Boot 使用 Log4j2</a></p>
<ol>
<li>spring boot的log4j2依赖</li>
<li>lombok自带log4j2</li>
</ol>
<h2 id="问题21jdbc基本">问题21、jdbc基本</h2>
<p><strong>1. 连接池</strong></p>
<p>连接池创建好固定数量的连接，数据库操作通过借用连接池的连接来进行操作，并且不关闭而是返还给连接池。</p>
<p><strong>2. try-with-resources</strong></p>
<p>实现<code>autoClosable</code>接口的类，均可以进行<code>try-with-resources</code>的操作。</p>
<p>close的顺序是，<strong>先进后出</strong>，类似堆栈。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>     <span style="color:#66d9ef">try</span> (Connection c <span style="color:#f92672">=</span> DriverManager.<span style="color:#a6e22e">getConnection</span>(<span style="color:#e6db74">&#34;jdbc:mysql://127.0.0.1:3306/how2java?characterEncoding=UTF-8&#34;</span>,<span style="color:#e6db74">&#34;root&#34;</span>, <span style="color:#e6db74">&#34;admin&#34;</span>);
</span></span><span style="display:flex;"><span>         Statement s <span style="color:#f92672">=</span> c.<span style="color:#a6e22e">createStatement</span>();) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         String sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;select * from hero where id = &#34;</span> <span style="color:#f92672">+</span> id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         ResultSet rs <span style="color:#f92672">=</span> s.<span style="color:#a6e22e">executeQuery</span>(sql);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 因为id是唯一的，ResultSet最多只能有一条记录</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// 所以使用if代替while</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (rs.<span style="color:#a6e22e">next</span>()) {
</span></span><span style="display:flex;"><span>             hero <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Hero();
</span></span><span style="display:flex;"><span>             String name <span style="color:#f92672">=</span> rs.<span style="color:#a6e22e">getString</span>(2);
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">float</span> hp <span style="color:#f92672">=</span> rs.<span style="color:#a6e22e">getFloat</span>(<span style="color:#e6db74">&#34;hp&#34;</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">int</span> damage <span style="color:#f92672">=</span> rs.<span style="color:#a6e22e">getInt</span>(4);
</span></span><span style="display:flex;"><span>             hero.<span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name;
</span></span><span style="display:flex;"><span>             hero.<span style="color:#a6e22e">hp</span> <span style="color:#f92672">=</span> hp;
</span></span><span style="display:flex;"><span>             hero.<span style="color:#a6e22e">damage</span> <span style="color:#f92672">=</span> damage;
</span></span><span style="display:flex;"><span>             hero.<span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> id;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     } <span style="color:#66d9ef">catch</span> (SQLException e) {
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">// TODO Auto-generated catch block</span>
</span></span><span style="display:flex;"><span>         e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><p><strong>3. ORM</strong></p>
<p>ORM=Object Relationship Database Mapping</p>
<p>对象和关系数据库的映射</p>
<p>简单说，<strong>一个对象</strong>，对应数据库里的<strong>一条记录</strong></p>
<p><strong>4. DAO</strong></p>
<p>DAO=<strong>D</strong>ata<strong>A</strong>ccess <strong>O</strong>bject</p>
<p>数据访问对象</p>
<p>实际上就是运用了<a href="https://how2j.cn/k/jdbc/jdbc-orm/391.html#step2641">练习-ORM</a>中的思路，把数据库相关的操作都封装在这个类里面，其他地方看不到JDBC的代码。通过设计类实现DAO接口，来完成对特定类的CRUD操作。</p>
<ol>
<li>把驱动的初始化放在了构造方法里</li>
<li>提供<code>getConnection</code>方法返回连接</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#f92672">package</span> jdbc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">import</span> charactor.Hero;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">DAO</span>{
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//增加</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(Hero hero);
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//修改</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span>(Hero hero);
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//删除</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">delete</span>(<span style="color:#66d9ef">int</span> id);
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//获取</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> Hero <span style="color:#a6e22e">get</span>(<span style="color:#66d9ef">int</span> id);
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//查询</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Hero<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">list</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//分页查询</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Hero<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">list</span>(<span style="color:#66d9ef">int</span> start, <span style="color:#66d9ef">int</span> count);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p><strong>改造jdbc工具类</strong></p>
<p><strong>增删改</strong></p>
<p>可以设置一个Object数组，用来占位Preparement的sql里的那些?，数组的长度就是预插入的值的数量，数组里的值就是可以录入到Preparestatement的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">//我们发现，增删改只有SQL语句和传入的参数是不知道的而已，所以让调用该方法的人传递进来</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//由于传递进来的参数是各种类型的，而且数目是不确定的，所以使用Object[]</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span>(String sql, Object<span style="color:#f92672">[]</span> objects) {
</span></span><span style="display:flex;"><span>         Connection connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         PreparedStatement preparedStatement <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         ResultSet resultSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>             connection <span style="color:#f92672">=</span> getConnection();
</span></span><span style="display:flex;"><span>             preparedStatement <span style="color:#f92672">=</span> connection.<span style="color:#a6e22e">prepareStatement</span>(sql);
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">//根据传递进来的参数，设置SQL占位符的值</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> objects.<span style="color:#a6e22e">length</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                 preparedStatement.<span style="color:#a6e22e">setObject</span>(i <span style="color:#f92672">+</span> 1, objects<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">//执行SQL语句</span>
</span></span><span style="display:flex;"><span>             preparedStatement.<span style="color:#a6e22e">executeUpdate</span>();
</span></span><span style="display:flex;"><span>          } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>             e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><p><strong>查询</strong></p>
<p>注意这里可以定义一个接口，对select的结果集进行操作，但是不知道需要具体进行操作，调用接口的实现类，接口就可以调用实现的方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         1:对于查询语句来说，我们不知道对结果集进行什么操作【常用的就是把数据封装成一个Bean对象，封装成一个List集合】
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         2:我们可以定义一个接口，让调用者把接口的实现类传递进来
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         3:这样接口调用的方法就是调用者传递进来实现类的方法。【策略模式】
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//这个方法的返回值是任意类型的，所以定义为Object。</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">query</span>(String sql, Object<span style="color:#f92672">[]</span> objects, ResultSetHandler rsh) {
</span></span><span style="display:flex;"><span>         Connection connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         PreparedStatement preparedStatement <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         ResultSet resultSet <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>             connection <span style="color:#f92672">=</span> getConnection();
</span></span><span style="display:flex;"><span>             preparedStatement <span style="color:#f92672">=</span> connection.<span style="color:#a6e22e">prepareStatement</span>(sql);
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">//根据传递进来的参数，设置SQL占位符的值</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (objects <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> objects.<span style="color:#a6e22e">length</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                     preparedStatement.<span style="color:#a6e22e">setObject</span>(i <span style="color:#f92672">+</span> 1, objects<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>             resultSet <span style="color:#f92672">=</span> preparedStatement.<span style="color:#a6e22e">executeQuery</span>();
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">//调用调用者传递进来实现类的方法，对结果集进行操作</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">return</span> rsh.<span style="color:#a6e22e">hanlder</span>(resultSet);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><p><strong>接口</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 定义对结果集操作的接口，调用者想要对结果集进行什么操作，只要实现这个接口即可
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ResultSetHandler</span> {
</span></span><span style="display:flex;"><span>          Object <span style="color:#a6e22e">hanlder</span>(ResultSet resultSet);
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><p><strong>实现示例</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">//接口实现类，对结果集封装成一个Bean对象</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BeanHandler</span> <span style="color:#66d9ef">implements</span> ResultSetHandler {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">//要封装成一个Bean对象，首先要知道Bean是什么，这个也是调用者传递进来的。</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> Class clazz;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">BeanHandler</span>(Class clazz) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">clazz</span> <span style="color:#f92672">=</span> clazz;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">hanlder</span>(ResultSet resultSet) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">//创建传进对象的实例化</span>
</span></span><span style="display:flex;"><span>             Object bean <span style="color:#f92672">=</span> clazz.<span style="color:#a6e22e">newInstance</span>();
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">if</span> (resultSet.<span style="color:#a6e22e">next</span>()) {
</span></span><span style="display:flex;"><span>                 <span style="color:#75715e">//拿到结果集元数据</span>
</span></span><span style="display:flex;"><span>                 ResultSetMetaData resultSetMetaData <span style="color:#f92672">=</span> resultSet.<span style="color:#a6e22e">getMetaData</span>();
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> resultSetMetaData.<span style="color:#a6e22e">getColumnCount</span>(); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">//获取到每列的列名</span>
</span></span><span style="display:flex;"><span>                     String columnName <span style="color:#f92672">=</span> resultSetMetaData.<span style="color:#a6e22e">getColumnName</span>(i<span style="color:#f92672">+</span>1);
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">//获取到每列的数据</span>
</span></span><span style="display:flex;"><span>                     String columnData <span style="color:#f92672">=</span> resultSet.<span style="color:#a6e22e">getString</span>(i<span style="color:#f92672">+</span>1);
</span></span><span style="display:flex;"><span>                     <span style="color:#75715e">//设置Bean属性</span>
</span></span><span style="display:flex;"><span>                     Field field <span style="color:#f92672">=</span> clazz.<span style="color:#a6e22e">getDeclaredField</span>(columnName);
</span></span><span style="display:flex;"><span>                     field.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                     field.<span style="color:#a6e22e">set</span>(bean,columnData);
</span></span><span style="display:flex;"><span>                 }
</span></span><span style="display:flex;"><span>                 <span style="color:#75715e">//返回Bean对象</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">return</span> bean;
</span></span><span style="display:flex;"><span>             }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="问题22java文件时间排序">问题22、Java文件时间排序</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span>        File<span style="color:#f92672">[]</span> files <span style="color:#f92672">=</span> FileUtil.<span style="color:#a6e22e">file</span>(img).<span style="color:#a6e22e">listFiles</span>();
</span></span><span style="display:flex;"><span>        Arrays.<span style="color:#a6e22e">sort</span>(files, (o1, o2) <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">long</span> diff <span style="color:#f92672">=</span> o1.<span style="color:#a6e22e">lastModified</span>() <span style="color:#f92672">-</span> o2.<span style="color:#a6e22e">lastModified</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (diff <span style="color:#f92672">&gt;</span> 0) <span style="color:#66d9ef">return</span> 1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (diff <span style="color:#f92672">==</span> 0) <span style="color:#66d9ef">return</span> 0;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1;
</span></span><span style="display:flex;"><span>        });
</span></span></code></pre></div><h2 id="问题23java方法重载中遇到的编译器错误">问题23、Java方法重载中遇到的编译器错误</h2>
<p>当两个重载函数的参数如下时：ide会出现编译错误 both methods have same erasure</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getData</span>(List<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;&gt;</span> dataList, Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> classs, OracleConnection con);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 要加入的函数，报错 both methods have same erasure</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getData</span>(List<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> dataList, Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> classs, OracleConnection con)
</span></span></code></pre></div><p>由于Java泛型在编译时擦除类型之后，上述方法会变成 void getData(List dataList)。</p>
<p><strong>1.  type erasure的本质</strong></p>
<p>泛型(T) &ndash;&gt; 编译器(type erasure) &ndash;&gt; 原始类型(T被Object替换)
泛型(? extends XXX) &ndash;&gt; 编译器(type erasure) &ndash;&gt; 原始类型(T被XXX替换)
原始类型指被编译器擦除了泛型信息后，类型变量在字节码中的具体类型。</p>
<p><strong>2.  type erasure导致泛型的局限性</strong></p>
<p>类型擦除降低了泛型的泛化性，使得某些重要的上下文环境中不能使用泛型类型，具有一定的局限性。</p>
<ul>
<li>
<p>运行时隐含类型转换的开销： 使用泛型时，Java编译器自动帮我们生成了类型转换的代码，这相对于C++模板来说无疑带来了额外的性能开销。</p>
</li>
<li>
<p>重载方法签名冲突</p>
</li>
<li>
<p>一个类不能实现同一个泛型接口的两种变体</p>
</li>
</ul>
<p>应该考虑在设计之初就进行List<!-- raw HTML omitted -->的写法，从而能够实现高拓展性。<a href="https://www.jianshu.com/p/f9da328c91be">Java泛型：类型擦除（type erasure）</a>有对泛型做一个通识性的讲解。</p>
<h2 id="问题23javasplit小数点的时候需要转义">问题23、JavaSplit小数点的时候需要转义</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;name&#34;</span>.<span style="color:#a6e22e">equalsIgnoreCase</span>(fieldName)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>value.<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">isEmpty</span>() <span style="color:#f92672">&amp;&amp;</span> value <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> functionType <span style="color:#f92672">==</span> 1) {
</span></span><span style="display:flex;"><span>        String names <span style="color:#f92672">=</span> value.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> names.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;\\.&#34;</span>)<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>; <span style="color:#75715e">// 横山站.110kV#1主变</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题24java对数字的替换">问题24、Java对数字的替换</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// outlet_count110kv ---&gt; outlet_count_110kv</span>
</span></span><span style="display:flex;"><span>String patterns <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;outlet_count[1,2,3,5][1,2,5,0][0,5]{0,1}kv&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (Pattern.<span style="color:#a6e22e">matches</span>(patterns, sb.<span style="color:#a6e22e">toString</span>())) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sb.<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">replaceFirst</span>(<span style="color:#e6db74">&#34;[0-9]&#34;</span>, <span style="color:#e6db74">&#34;_$0&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sb.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题25java的split拆分文件路径">问题25、Java的split拆分文件路径</h2>
<p>用了正则，匹配<code>\</code>和<code>/</code>两个</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#f92672">[]</span> pathArray <span style="color:#f92672">=</span> remotePath.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;[\\\\/]&#34;</span>);
</span></span></code></pre></div><h2 id="问题26saxparseexception报错">问题26、SAXParseException报错</h2>
<p>Caused by: org.xml.sax.SAXParseException：元素内容必须由格式正确的字符数据或标记组成。</p>
<pre tabindex="0"><code>and PLAN_START_TIME &gt;= date_format(#{startTime},&#39;%Y-%m-%d %H:%i:%s&#39;)

and PLAN_START_TIME &amp;It;= date_format(#{startTime},&#39;%Y-%m-%d %H:%i:%s&#39;)
</code></pre><p>用&amp;lt；代替小于号，用&amp;gt；代替大于号</p>
<h2 id="问题27mybatis-plus3的ew带where问题">问题27、mybatis-plus3的ew带where问题</h2>
<p>${ew.customSqlSegment}带where</p>
<p>${ew.sqlSegment}不带where</p>
<p>注意看源码中getCustomSqlSegment的实现，能够发现customSqlSegment在sqlSegment的基础上拼接了where</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getCustomSqlSegment</span>() {
</span></span><span style="display:flex;"><span>        MergeSegments expression <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getExpression</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Objects.<span style="color:#a6e22e">nonNull</span>(expression)) {
</span></span><span style="display:flex;"><span>            NormalSegmentList normal <span style="color:#f92672">=</span> expression.<span style="color:#a6e22e">getNormal</span>();
</span></span><span style="display:flex;"><span>            String sqlSegment <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getSqlSegment</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isNotBlank</span>(sqlSegment)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (normal.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> sqlSegment;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;WHERE &#34;</span> <span style="color:#f92672">+</span> sqlSegment;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="问题28redistemplate设置和获取缓存过期时间">问题28、redisTemplate设置和获取缓存过期时间</h2>
<p>设置和获取过期时间</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 设置过期时间，两种方式</span>
</span></span><span style="display:flex;"><span>stringKeyRedisTemplate.<span style="color:#a6e22e">opsForValue</span>().<span style="color:#a6e22e">set</span>(key, preset);
</span></span><span style="display:flex;"><span>stringKeyRedisTemplate.<span style="color:#a6e22e">expireAt</span>(key, time);
</span></span><span style="display:flex;"><span>stringKeyRedisTemplate.<span style="color:#a6e22e">expire</span>(key, overdueTime, TimeUnit.<span style="color:#a6e22e">SECONDS</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 获取过期时间</span>
</span></span><span style="display:flex;"><span>stringKeyRedisTemplate.<span style="color:#a6e22e">getExpire</span>(keyObj, TimeUnit.<span style="color:#a6e22e">SECONDS</span>);
</span></span></code></pre></div><h2 id="问题29spring-boot-datetimeformat-和-jsonformat-注解">问题29、Spring Boot @DateTimeFormat 和 @JsonFormat 注解</h2>
<p><code>@DateTimeFormat</code>和 <code>@JsonFormat</code>用于标注在实体对象的日期变量上，例如:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@DateTimeFormat</span>(pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;yyyy-MM-dd&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@JsonFormat</span>(pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;yyyy-MM-dd&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Date birthday;
</span></span></code></pre></div><p><code>@DateTimeFormat(pattern)</code>用于将前端传过来的日期字符串自动转化为日期对象;</p>
<p><code>@JsonFormat(pattern)</code>用于将数据库中取出来的日期对象自动调整为<code>pattern</code>格式的日期对象。</p>
<h2 id="问题30mybatis-plus分页插件问题-every-derived-table-must-have-its-own-alias">问题30、MyBatis Plus分页插件问题， Every derived table must have its own alias</h2>
<p>项目中遇到SQL报错抛异常，报错内容如下。</p>
<p>[Code: 1248, SQL State: 42000] Every derived table must have its own alias</p>
<p>查看报错的SQL如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> TMP_PAGE.<span style="color:#f92672">*</span>, ROWNUM ROW_ID <span style="color:#66d9ef">FROM</span> ......
</span></span></code></pre></div><p>很明显，ROWNUM是属于Oracle的语法，而把出错的语句放到Oracle环境下执行是没有问题的。而放在MySQL下才会有问题。而问题的根源在于MyBatis Plus分页插件所使用的方言导致的。因为MyBatis的子查询并不需要别名(alias)。当然，即使手动把SQL语句加上别名，执行SQL也依然会报其他错误，因为MySQL没有ROWNUM的概念。通常情况下，都会根据Every derived table must have its own alias到网上找解决方案，结果无一例外的提示需要给表加别名。</p>
<p>解决办法：</p>
<p>在分页插件的配置中，指定好数据库的类型。</p>
<p>springboot config类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * mybatis-plus分页插件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> PaginationInterceptor <span style="color:#a6e22e">paginationInterceptor</span>() {
</span></span><span style="display:flex;"><span>        PaginationInterceptor page <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PaginationInterceptor();
</span></span><span style="display:flex;"><span>        page.<span style="color:#a6e22e">setLimit</span>(<span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> String mySqlType<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mysql&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(url.<span style="color:#a6e22e">contains</span>(mySqlType)){
</span></span><span style="display:flex;"><span>            page.<span style="color:#a6e22e">setDbType</span>(DbType.<span style="color:#a6e22e">MYSQL</span>);
</span></span><span style="display:flex;"><span>            page.<span style="color:#a6e22e">setCountSqlParser</span>(<span style="color:#66d9ef">new</span> JsqlParserCountOptimize(<span style="color:#66d9ef">true</span>));
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>            page.<span style="color:#a6e22e">setDbType</span>(DbType.<span style="color:#a6e22e">ORACLE</span>);
</span></span><span style="display:flex;"><span>            page.<span style="color:#a6e22e">setCountSqlParser</span>(<span style="color:#66d9ef">new</span> JsqlParserCountOptimize(<span style="color:#66d9ef">true</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> page;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>或者在xml配置中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin</span> <span style="color:#a6e22e">interceptor=</span><span style="color:#e6db74">&#34;com.github.pagehelper.PageInterceptor&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!-- 设置数据库类型 Oracle,Mysql,MariaDB,SQLite,Hsqldb,PostgreSQL六种数据库--&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;helperDialect&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;oracle&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;databaseIdProvider</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;DB_VENDOR&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;MySQL&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;mysql&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Oracle&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;oracle&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SQL Server&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;sqlserver&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;property</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;DB2&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;DB2&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/databaseIdProvider&gt;</span>
</span></span></code></pre></div><h2 id="问题31达梦数据库指定模式名存疑">问题31、达梦数据库指定模式名【存疑】</h2>
<p>JDBC URL属性为：schema，指定用户登录后的当前模式，默认为用户的默认模式。</p>
<p>JDBC URL为：jdbc:dm://ip:port?schema=模式名</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dm.jdbc.driver.DmDriver&#34;</span>;
</span></span><span style="display:flex;"><span>String url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;jdbc:dm://192.168.15.35:5236?schema=TEST2&#34;</span>;     <span style="color:#75715e">//使用schema指定当前模式名</span>
</span></span><span style="display:flex;"><span>String user<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;TEST&#34;</span>;
</span></span><span style="display:flex;"><span>String password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;123456789&#34;</span>;
</span></span></code></pre></div><p>注意在mybatis-plus+druid的springboot后端框架中，使用该方式仍然读取的用户的默认模式，故该问题可能存在兼容性问题。</p>
<h2 id="问题32redis集群下的过期监听事件notify-keyspace-events">问题32、Redis集群下的过期监听事件notify-keyspace-events</h2>
<p><a href="https://links.jianshu.com/go?to=http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU2NjcyMTM0Mg%3D%3D%26mid%3D2247485252%26idx%3D1%26sn%3D90e3b578904f155733ca1980f52ba0f2%26chksm%3Dfca96915cbdee0031cdfae63af6509c11047956c228afdf69cfec73e8a71fffd1b853e33d5fc%26scene%3D21%23wechat_redirect">SpringBoot整合Redis，订阅、发布、过期事件</a></p>
<p>针对单例redis的，换成redis集成环境，监听事件就失效了，只能重新写。</p>
<p><strong>数据库通知介绍</strong></p>
<p>数据库通知 是 Redis 2.8 版本新增加的功能，这个功能可以让客户端通过发布/订阅给定的频道或者模式，来获知数据库中键的变化，以及数据库中命令的执行情况。</p>
<p><strong>分类：</strong></p>
<p><strong>键空间通知：某个键执行了什么命令</strong>（key-space notification）</p>
<p>**键事件通知：**某个命令被什么键执行了（key-event notification）</p>
<blockquote>
<p>K  键空间通知，以 <strong>keyspace@<!-- raw HTML omitted --></strong>  为前缀</p>
<p>E  键事件通知， 以<strong>keyevent@<!-- raw HTML omitted --></strong>  为前缀</p>
<p>g   del，expire，rename等无关的通用命令的集合</p>
<p>$    String命令</p>
<p>l     List命令</p>
<p>s     Set命令</p>
<p>h     Hash命令</p>
<p>z     有序集合命令</p>
<p>x     过期事件（key过期时生成）</p>
<p>e     驱逐事件（内存满了，key被清除时）</p>
<p>A     以上 g$lshzxe的集合，AKE 代表接收全部的通知</p>
</blockquote>
<p><strong>第一步，redis配置文件的修改；</strong>
过期事件，属于键事件通知，因此在监听过期事件时，需要在集群中的每个redis的配置文件中写上：<strong>notify-keyspace-events Ex</strong>
默认notify-keyspace-events &ldquo;&quot;，不接收任何通知。</p>
<p><strong>第二步，测试代码；</strong></p>
<p>在作者的原有部分的代码上进行了改造，实现了自己的业务逻辑。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.nrec.pcs9000.app.service;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.nrec.pcs9000.app.constants.AppConstant;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.RedisURI;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.RedisClusterClient;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.models.partitions.RedisClusterNode;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.pubsub.RedisClusterPubSubAdapter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.pubsub.StatefulRedisClusterPubSubConnection;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.pubsub.api.async.NodeSelectionPubSubAsyncCommands;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.cluster.pubsub.api.async.PubSubAsyncNodeSelection;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io.lettuce.core.pubsub.RedisPubSubAdapter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Value;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.ApplicationArguments;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.ApplicationRunner;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.stereotype.Service;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.annotation.Resource;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 类&lt;code&gt;Doc&lt;/code&gt;用于：监听守望位缓存{@link RedisClusterSubscribeService}过期事件，执行守望位跳转
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @author luohao
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @date 2022/2/16 15:32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisClusterSubscribeService</span> <span style="color:#66d9ef">extends</span> RedisPubSubAdapter <span style="color:#66d9ef">implements</span> ApplicationRunner {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(RedisClusterSubscribeService.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 过期事件监听通道
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String EXPIRED_CHANNEL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;__keyevent@0__:expired&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span>(<span style="color:#e6db74">&#34;${spring.redis.cluster.nodes}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String clusterNodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Value</span>(<span style="color:#e6db74">&#34;${spring.redis.password}&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String password;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ICameraKeepWatchService keepWatchService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(ApplicationArguments args) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;监听Redis过期事件，用于守望位......&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//项目启动后就运行该方法</span>
</span></span><span style="display:flex;"><span>        startListener();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 启动监听
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@SuppressWarnings</span>(<span style="color:#e6db74">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startListener</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//redis集群监听</span>
</span></span><span style="display:flex;"><span>        String<span style="color:#f92672">[]</span> redisNodes <span style="color:#f92672">=</span> clusterNodes.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//监听其中一个端口号即可</span>
</span></span><span style="display:flex;"><span>        RedisURI redisURI <span style="color:#f92672">=</span> RedisURI.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;redis://&#34;</span> <span style="color:#f92672">+</span> redisNodes<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>        redisURI.<span style="color:#a6e22e">setPassword</span>(password);
</span></span><span style="display:flex;"><span>        RedisClusterClient clusterClient <span style="color:#f92672">=</span> RedisClusterClient.<span style="color:#a6e22e">create</span>(redisURI);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StatefulRedisClusterPubSubConnection<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> pubSubConnection <span style="color:#f92672">=</span> clusterClient.<span style="color:#a6e22e">connectPubSub</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//redis节点间消息的传播为true</span>
</span></span><span style="display:flex;"><span>        pubSubConnection.<span style="color:#a6e22e">setNodeMessagePropagation</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//过期消息的接受和处理</span>
</span></span><span style="display:flex;"><span>        pubSubConnection.<span style="color:#a6e22e">addListener</span>(<span style="color:#66d9ef">new</span> RedisClusterPubSubAdapter() {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">message</span>(RedisClusterNode node, Object channel, Object message) {
</span></span><span style="display:flex;"><span>                String expiredKey <span style="color:#f92672">=</span> message.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>                workingOnExpireKey(expiredKey);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//异步操作</span>
</span></span><span style="display:flex;"><span>        PubSubAsyncNodeSelection<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> masters <span style="color:#f92672">=</span> pubSubConnection.<span style="color:#a6e22e">async</span>().<span style="color:#a6e22e">masters</span>();
</span></span><span style="display:flex;"><span>        NodeSelectionPubSubAsyncCommands<span style="color:#f92672">&lt;</span>String, String<span style="color:#f92672">&gt;</span> commands <span style="color:#f92672">=</span> masters.<span style="color:#a6e22e">commands</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//设置订阅消息类型，一个或多个</span>
</span></span><span style="display:flex;"><span>        commands.<span style="color:#a6e22e">subscribe</span>(EXPIRED_CHANNEL);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">workingOnExpireKey</span>(String expiredKey) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 无论是强制的还是普通守望位缓存过期，均调用预置位</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (expiredKey.<span style="color:#a6e22e">contains</span>(AppConstant.<span style="color:#a6e22e">COMMON_KEEPWATCH_OVERDUE_TIME_KEY</span>) <span style="color:#f92672">||</span> expiredKey.<span style="color:#a6e22e">contains</span>(AppConstant.<span style="color:#a6e22e">FORCE_KEEPWATCH_OVERDUE_TIME_KEY</span>)) {
</span></span><span style="display:flex;"><span>            keepWatchService.<span style="color:#a6e22e">doKeepWatch</span>(expiredKey);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题33scopeprototype的正确用法解决bean的多例问题">问题33、@Scope(&ldquo;prototype&rdquo;)的正确用法——解决Bean的多例问题</h2>
<p><strong>1、Spring管理的某个Bean需要使用多例</strong></p>
<p>可以使用<code>@Scope(&quot;prototype&quot;)</code>,注解在需要使用多例的这个类上。</p>
<p><strong>2、问题升级：多个Bean的依赖链中，有一个需要多例</strong></p>
<p>真实的Spring Web工程起码有Controller、Service、Dao三层，假如Controller层是单例，Service层需要多例，这时候应该怎么办呢？</p>
<p><strong>成功方法一、在Controller和Service都加上注解，controller（@Autowired注入service）</strong></p>
<blockquote>
<p>直接在Service层加注解<code>@Scope(&quot;prototype&quot;)</code>，失败。</p>
<p>在Controller和Service都加上<code>@Scope(&quot;prototype&quot;)</code>，成功。</p>
</blockquote>
<p>Spring定义了多种作用域，可以基于这些作用域创建bean，包括：</p>
<ul>
<li>单例（ Singleton）：在整个应用中，只创建bean的一个实例。</li>
<li>原型（ Prototype）：每次注入或者通过Spring应用上下文获取的时候，都会创建一个新的bean实例。</li>
</ul>
<p>  对于以上说明，我们可以这样理解：虽然Service是多例的，但是Controller是单例的。如果给一个组件加上<code>@Scope(&quot;prototype&quot;)</code>注解，每次请求它的实例，spring的确会给返回一个新的。问题是这个多例对象Service是被单例对象Controller依赖的。而单例服务Controller初始化的时候，多例对象Service就已经注入了；当你去使用Controller的时候，Service也不会被再次创建了（注入时创建，而注入只有一次）。</p>
<p><strong>成功方法二、在Service都加上注解，controller（通过SpringBeanUtil.getBean注入service）</strong></p>
<p>在Controller钟每次去请求获取Service实例，而不是使用<code>@Autowired</code>注入，成功。</p>
<p><strong>3、技术总结</strong></p>
<ul>
<li>方法一，为了一个多例，让整个一串Bean失去了单例的优势；</li>
<li>方法二，破坏IOC注入的优美展现形式，和new一样不便于管理和修改。</li>
</ul>
<p>Spring作为一个优秀的、用途广、发展时间长的框架，一定有成熟的解决办法。经过一番搜索，我们发现，注解<code>@Scope(&quot;prototype&quot;)</code>（这个注解实际上也可以写成<code>@Scope(value = ConfigurableBeanFactory.SCOPE_PROTOTYPE</code>，使用常量比手打字符串不容易出错）还有很多用法。
 首先value就分为四类：</p>
<blockquote>
<ul>
<li>ConfigurableBeanFactory.SCOPE_PROTOTYPE，即“prototype”</li>
<li>ConfigurableBeanFactory.SCOPE_SINGLETON，即“singleton”</li>
<li>WebApplicationContext.SCOPE_REQUEST，即“request”</li>
<li>WebApplicationContext.SCOPE_SESSION，即“session”</li>
</ul>
</blockquote>
<p>  他们的含义是：</p>
<blockquote>
<ul>
<li>singleton和prototype分别代表单例和多例；</li>
<li>request表示请求，即在一次http请求中，被注解的Bean都是同一个Bean，不同的请求是不同的Bean；</li>
<li>session表示会话，即在同一个会话中，被注解的Bean都是使用的同一个Bean，不同的会话使用不同的Bean。</li>
</ul>
</blockquote>
<p>使用session和request产生了一个新问题，生成controller的时候需要service作为controller的成员，但是service只在收到请求（可能是request也可能是session）时才会被实例化，controller拿不到service实例。为了解决这个问题，<code>@Scope</code>注解添加了一个proxyMode的属性，有两个值<code>ScopedProxyMode.INTERFACES</code>和<code>ScopedProxyMode.TARGET_CLASS</code>，前一个表示表示Service是一个接口，后一个表示Service是一个类。</p>
<p>本文遇到的问题中，将<code>@Scope</code>注解改成<code>@Scope(value = WebApplicationContext.SCOPE_REQUEST, proxyMode = ScopedProxyMode.TARGET_CLASS)</code>就可以使用注入@Autowired的方式来同样实现了。</p>
<h2 id="问题34时间格式与cron表达式">问题34、时间格式与cron表达式</h2>
<p>1、根据指定时间生成cron表达式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 通过输入指定日期时间生成cron表达式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param date
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return cron表达式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span>  String <span style="color:#a6e22e">getCron</span>(Date date){
</span></span><span style="display:flex;"><span>        String dateFormat<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ss mm HH dd MM ? yyyy&#34;</span>;
</span></span><span style="display:flex;"><span>        SimpleDateFormat sdf <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleDateFormat(dateFormat);
</span></span><span style="display:flex;"><span>        String formatTimeStr <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (date <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            formatTimeStr <span style="color:#f92672">=</span> sdf.<span style="color:#a6e22e">format</span>(date);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> formatTimeStr;
</span></span></code></pre></div><p>2、hutool提供的工具类</p>
<p>CronPatternUtil.matchedDates() 能够列举指定日期范围内所有匹配表达式的日期、</p>
<p>CronPattern.match() 判断给定时间是否匹配定时任务表达式</p>
<h2 id="问题35spring-jpa-使用注解映射mysql数据库的blob和text类型数据">问题35、Spring JPA 使用注解映射MySQL数据库的Blob和Text类型数据</h2>
<ul>
<li>Clob（Character Large Ojects）类型是长字符串类型，具体的java.sql.Clob, Character[], char[] 和 java.lang.String 将被持久化为 Clob 类型。</li>
<li>Blob（Binary Large Objects）类型是字节类型，具体的java.sql.Blob, Byte[], byte[] 和 serializable type 将被持久化为 Blob 类型。</li>
<li>@Lob 持久化为Blob或者Clob类型,根据get方法的返回值不同,自动进行Clob和Blob的转换。</li>
<li>因为这两种类型的数据一般占用的内存空间比较大，所以通常使用延迟加载的方式，与@Basic标记同时使用，设置加载方式为FetchType.LAZY。
<em>参考：</em> <a href="https://link.jianshu.com?t=http://blog.csdn.net/axzywan/article/details/7895263">浅谈JPA的Blob和Clob注解方法</a></li>
</ul>
<p>在MySQL中Blob和Clob对应的的字段类型有</p>
<blockquote>
<p>tinytext (tintblob)、text (blob)、mediumtext (mediumblob)和longtext (longblob)
<em>参考：</em> <a href="https://link.jianshu.com?t=http://www.cnblogs.com/pureEve/p/6015000.html">MySQL中tinytext、text、mediumtext和longtext详解</a></p>
</blockquote>
<p>一般在java中Clob类型用String声明，Blob用byte[]声明MySQL数据库对应字段，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#a6e22e">@Lob</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Basic</span>(fetch = <span style="color:#a6e22e">FetchType</span>.LAZY)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Column</span>(name = <span style="color:#e6db74">&#34;f_task_content&#34;</span>, nullable = <span style="color:#66d9ef">false</span>, columnDefinition = <span style="color:#e6db74">&#34;Text&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> String taskContent;
</span></span></code></pre></div><h2 id="问题36去掉字符串中的回车换行制表符">问题36、去掉字符串中的回车、换行、制表符</h2>
<p>若一个字符串存在<code>\n(换行)\r(回车)\t(制表)</code>符。那么即使相同内容的字符串（不含特殊符号），他们的equals方法也会不同。这就要求我们移除这些特殊符号。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 在正则表达式中\s表示所有的空格：    匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [ \f\n\r\t\v]。注意 Unicode 正则表达式会匹配全角空格符。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 使用正则表达式,移除换行符（且不移除空格）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param originalStr 原始字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return 移除换行\r、回车\n、制表\t符的字符串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">removeRNT</span>(String originalStr) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (originalStr <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> originalStr.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> originalStr;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> originalStr.<span style="color:#a6e22e">replaceAll</span>(<span style="color:#e6db74">&#34;[\t\n\r]&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>);s
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 移除字符串中所有的空白格（包含换行\r、回车\n、制表\t符）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param str 原始串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return 无空格后的串
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">trimAllWhitespace</span>(String str) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (str <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> str.<span style="color:#a6e22e">isEmpty</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> str;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> str.<span style="color:#a6e22e">length</span>();
</span></span><span style="display:flex;"><span>        StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder(str.<span style="color:#a6e22e">length</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> len; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> str.<span style="color:#a6e22e">charAt</span>(i);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>Character.<span style="color:#a6e22e">isWhitespace</span>(c)) {
</span></span><span style="display:flex;"><span>                sb.<span style="color:#a6e22e">append</span>(c);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sb.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>移除特殊符号的时候，可以使用正则表达式，但是也要注意，不要把正常的空格符给移除。</p>
<h2 id="问题37解决poi读取excel如何判断行是不是为空">问题37、解决POI读取Excel如何判断行是不是为空</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRowEmpty</span>(Row row) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> row.<span style="color:#a6e22e">getFirstCellNum</span>(); c <span style="color:#f92672">&lt;</span> row.<span style="color:#a6e22e">getLastCellNum</span>(); c<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        Cell cell <span style="color:#f92672">=</span> row.<span style="color:#a6e22e">getCell</span>(c);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (cell <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> cell.<span style="color:#a6e22e">getCellType</span>() <span style="color:#f92672">!=</span> Cell.<span style="color:#a6e22e">CELL_TYPE_BLANK</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题38忽略https证书no-subject-alternative-names-present">问题38、忽略https证书：No subject alternative names present</h2>
<p>做项目提供restful api，本地部署访问http://localhost:8080可以正确访问，当部署到一个高安全性的服务器上时，项目访问路径变成了https://xxx.xxx.xxx.xxx:xxxx，此时再次测试时会报错。</p>
<pre tabindex="0"><code>javax.net.ssl.SSLHandshakeException: java.security.cert.CertificateException: No subject alternative names present
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> InputStream <span style="color:#a6e22e">getUrlPictureStream</span>(String urlPath) <span style="color:#66d9ef">throws</span> IOException, NoSuchAlgorithmException, KeyManagementException {
</span></span><span style="display:flex;"><span>        String fullUrl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://198.120.100.102&#34;</span> <span style="color:#f92672">+</span> urlStringEncode(urlPath);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SslUtils.<span style="color:#a6e22e">getUrlInputStream</span>(fullUrl);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>错误猜测为证书问题。因为本身https请求就对证书有要求，于是将代码修改如下，可以绕过证书问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.nrec.pcs9000.app.util;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @author luohao
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @date 2021/9/27 21:18
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.net.ssl.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.InputStream;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.HttpURLConnection;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URL;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.KeyManagementException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.NoSuchAlgorithmException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.SecureRandom;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.cert.CertificateException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.security.cert.X509Certificate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SslUtils</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> NullHostNameVerifier nullHostNameVerifier <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NullHostNameVerifier();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> TrustManager<span style="color:#f92672">[]</span> trustAllCerts <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TrustManager<span style="color:#f92672">[]</span>{<span style="color:#66d9ef">new</span> X509TrustManager() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkClientTrusted</span>(X509Certificate<span style="color:#f92672">[]</span> chain, String authType) <span style="color:#66d9ef">throws</span> CertificateException {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkServerTrusted</span>(X509Certificate<span style="color:#f92672">[]</span> chain, String authType) <span style="color:#66d9ef">throws</span> CertificateException {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> X509Certificate<span style="color:#f92672">[]</span> <span style="color:#a6e22e">getAcceptedIssuers</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">SslUtils</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> InputStream <span style="color:#a6e22e">getUrlInputStream</span>(String urlStr)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> IOException, KeyManagementException, NoSuchAlgorithmException {
</span></span><span style="display:flex;"><span>        HttpsURLConnection.<span style="color:#a6e22e">setDefaultHostnameVerifier</span>(nullHostNameVerifier);
</span></span><span style="display:flex;"><span>        SSLContext sc <span style="color:#f92672">=</span> SSLContext.<span style="color:#a6e22e">getInstance</span>(<span style="color:#e6db74">&#34;TLS&#34;</span>);
</span></span><span style="display:flex;"><span>        sc.<span style="color:#a6e22e">init</span>(<span style="color:#66d9ef">null</span>, trustAllCerts, <span style="color:#66d9ef">new</span> SecureRandom());
</span></span><span style="display:flex;"><span>        HttpsURLConnection.<span style="color:#a6e22e">setDefaultSSLSocketFactory</span>(sc.<span style="color:#a6e22e">getSocketFactory</span>());
</span></span><span style="display:flex;"><span>        URL url <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> URL(urlStr);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 打开restful链接</span>
</span></span><span style="display:flex;"><span>        HttpURLConnection conn <span style="color:#f92672">=</span> (HttpURLConnection) url.<span style="color:#a6e22e">openConnection</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// conn.setRequestMethod(&#34;POST&#34;);// POST GET PUT DELETE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置访问提交模式，表单提交</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// conn.setRequestProperty(&#34;Content-Type&#34;, &#34;application/json;charset=utf-8&#34;);</span>
</span></span><span style="display:flex;"><span>        conn.<span style="color:#a6e22e">setConnectTimeout</span>(130000);<span style="color:#75715e">// 连接超时 单位毫秒</span>
</span></span><span style="display:flex;"><span>        conn.<span style="color:#a6e22e">setReadTimeout</span>(130000);<span style="color:#75715e">// 读取超时 单位毫秒</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 读取请求返回值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> conn.<span style="color:#a6e22e">getInputStream</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NullHostNameVerifier</span> <span style="color:#66d9ef">implements</span> HostnameVerifier {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * (non-Javadoc)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * @see javax.net.ssl.HostnameVerifier#verify(java.lang.String,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * javax.net.ssl.SSLSession)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">verify</span>(String arg0, SSLSession arg1) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题39knife4j-实现文件下载及图片预览">问题39、knife4j 实现文件下载及图片预览</h2>
<p>目前<code>SwaggerBootstrapUi</code>以及<code>knife4j</code>支持的响应类型如下：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>application/octet-stream</td>
<td>二进制流</td>
</tr>
<tr>
<td>image/png</td>
<td>图片</td>
</tr>
<tr>
<td>image/jpg</td>
<td>图片</td>
</tr>
<tr>
<td>image/jpeg</td>
<td>图片</td>
</tr>
<tr>
<td>image/gif</td>
<td>图片</td>
</tr>
</tbody>
</table>
<p><strong>特别需要注意的是</strong>：不管是文件下载或者是需要图片预览,都需要在接口中指定接口的<code>produces</code>,否则不能达到预期效果,接口的produces可参考上面表格中列出项.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@ApiOperation</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;下载测试-有参数+请求头版&#34;</span>,position <span style="color:#f92672">=</span> 3)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/downloadFileAndParam2&#34;</span>,produces <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;application/octet-stream&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postRequest3AndParam</span>(<span style="color:#a6e22e">@RequestHeader</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;uud&#34;</span>) String uud,<span style="color:#a6e22e">@RequestParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;name&#34;</span>) String name, HttpServletRequest request, HttpServletResponse response){
</span></span><span style="display:flex;"><span>    logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;header:{}&#34;</span>,uud);
</span></span><span style="display:flex;"><span>    download(name,response);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Api</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;图片预览&#34;</span>,tags <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;图片预览&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/api/image&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/preview&#34;</span>,produces <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;image/jpeg&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">preview</span>(HttpServletRequest request, HttpServletResponse response) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//more....</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题40lombok使用">问题40、lombok使用</h2>
<h3 id="1使用requiredargsconstructorfinal代替autowired和resource">1、使用@RequiredArgsConstructor+final代替@Autowired和@Resource</h3>
<blockquote>
<p>@NoArgsConstructor后会 生成无参的构造方法</p>
<p>@RequiredArgsConstructor会将类的每一个final字段或者non-null字段生成一个构造方法</p>
<p>@AllArgsConstructor 生成一个包含过所有字段的构造方法。</p>
</blockquote>
<p>@AllArgsConstructor 和@RequiredArgsConstructor都可以用来替换@Autowired写法，区别在@RequiredArgsConstructor必须要有final修饰。</p>
<blockquote>
<p>遇到坑，使用<code>@AllArgsConstructor</code>后，<code>@Value</code>会失效，获取不到值。使用<code>@RequiredArgsConstructor</code>则正常。今后注入service、mapper等都使用<code>@RequiredArgsConstructor</code>好了。</p>
</blockquote>
<p>Springboot官方建议使用final来修饰成员变量，然后通过构造方法来进行注入原因：final修饰的成员变量是不能够被修改的，反射那就没办法了</p>
<p>下面就是Spring推荐的写法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> UserService userService;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">OrderService</span>(UserService userService) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userService</span> <span style="color:#f92672">=</span> userService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>@RequiredArgsConstructor也是在类上使用，但是这个注解可以生成带参或者不带参的构造方法。</p>
<p>若带参数，只能是类中所有带有 @NonNull注解的和以final修饰的未经初始化的字段</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequiredArgsConstructor</span>(onConstructor <span style="color:#f92672">=</span> <span style="color:#a6e22e">@__</span>(<span style="color:#a6e22e">@Autowired</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//这里必须是final,若不使用final,用@NotNull注解也是可以的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@NotNull</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> PayService payService;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequiredArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//这里必须是final,若不使用final,用@NotNull注解也是可以的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> UserService userService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@NotNull</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> PayService payService;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2sneakythrows-抛出异常">2、@SneakyThrows 抛出异常</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SneakyThrows</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkCode</span>(ServerHttpRequest request) {
</span></span><span style="display:flex;"><span>    String code <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getQueryParams</span>().<span style="color:#a6e22e">getFirst</span>(<span style="color:#e6db74">&#34;code&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (StrUtil.<span style="color:#a6e22e">isBlank</span>(code)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ValidateCodeException(<span style="color:#e6db74">&#34;验证码不能为空&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    redisTemplate.<span style="color:#a6e22e">delete</span>(key);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不使用就要加这个抛出</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkCode</span>(ServerHttpRequest request) <span style="color:#66d9ef">throws</span> ValidateCodeException {
</span></span><span style="display:flex;"><span>    String code <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getQueryParams</span>().<span style="color:#a6e22e">getFirst</span>(<span style="color:#e6db74">&#34;code&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (StrUtil.<span style="color:#a6e22e">isBlank</span>(code)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ValidateCodeException(<span style="color:#e6db74">&#34;验证码不能为空&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3utilityclass-工具类再也不用定义static的方法了直接就可以classmethod-使用">3、@UtilityClass 工具类再也不用定义static的方法了，直接就可以Class.Method 使用</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@UtilityClass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Utility</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;name&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Utility.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="4cleanup-清理流对象不用手动去关闭流多么优雅">4、@CleanUp: 清理流对象,不用手动去关闭流，多么优雅</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Cleanup</span>
</span></span><span style="display:flex;"><span>OutputStream outStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream(<span style="color:#66d9ef">new</span> File(<span style="color:#e6db74">&#34;text.txt&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Cleanup</span>
</span></span><span style="display:flex;"><span>InputStream inStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream(<span style="color:#66d9ef">new</span> File(<span style="color:#e6db74">&#34;text2.txt&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>65536<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> inStream.<span style="color:#a6e22e">read</span>(b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>1) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    outStream.<span style="color:#a6e22e">write</span>(b, 0, r); 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="5equalsandhashcode生成equals和hashcode方法">5、@EqualsAndHashCode：生成<code>equals</code>和<code>hashCode</code>方法</h3>
<p>exclude方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@EqualsAndHashCode</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EqualsAndHashCodeExample</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">int</span> transientVar <span style="color:#f92672">=</span> 10;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String name;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> score;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@EqualsAndHashCode.Exclude</span> <span style="color:#66d9ef">private</span> Shape shape <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Square(5, 10); <span style="color:#75715e">// 这个属性被排除</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> String<span style="color:#f92672">[]</span> tags;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@EqualsAndHashCode.Exclude</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> id; <span style="color:#75715e">// 这个属性被排除</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getName</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@EqualsAndHashCode</span>(callSuper<span style="color:#f92672">=</span><span style="color:#66d9ef">true</span>) <span style="color:#75715e">// 调用父类属性</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Square</span> <span style="color:#66d9ef">extends</span> Shape {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> width, height;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Square</span>(<span style="color:#66d9ef">int</span> width, <span style="color:#66d9ef">int</span> height) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> width;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> height;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>include的方式</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@EqualsAndHashCode</span>(onlyExplicitlyIncluded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>, callSuper <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@TableName</span>(<span style="color:#e6db74">&#34;point_acquire&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ApiModel</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PointAcquire对象&#34;</span>, description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位表&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PointAcquire</span> <span style="color:#66d9ef">extends</span> SuperEntity<span style="color:#f92672">&lt;</span>PointAcquire<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Excel</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TableId</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;id&#34;</span>, type <span style="color:#f92672">=</span> IdType.<span style="color:#a6e22e">ASSIGN_UUID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApiModelProperty</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位编号&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Excel</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位编号&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@EqualsAndHashCode.Include</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String acquirePointCode;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="6fieldnameconstants-获取类的属性名称">6、@FieldNameConstants 获取类的属性名称</h3>
<p>直接使用效果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.experimental.FieldNameConstants;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.AccessLevel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@FieldNameConstants</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FieldNameConstantsExample</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String iAmAField;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> andSoAmI;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 添加 @FieldNameConstants.Exclude 这个注解表示该属性名不需要提供属性名</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@FieldNameConstants.Exclude</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> asAmI;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>代码效果</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FieldNameConstantsExample</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String iAmAField;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> andSoAmI;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> asAmI;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Fields</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String iAmAField <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;iAmAField&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String andSoAmI <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;andSoAmI&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="一些定制需求">一些定制需求</h5>
<ol>
<li>
<p>如果希望使用枚举类型: @FieldNameConstants(asEnum = true)</p>
</li>
<li>
<p>如果希望使用是全大写的输出结果，修改lombok配置，注解方式无法配置！</p>
<pre tabindex="0"><code>lombok.fieldNameConstants.uppercase = true
</code></pre></li>
<li>
<p>默认内部类名是 Fields ,而且是 public。如果想临时修改，可以使用注解配置：@FieldNameConstants(innerTypeName = &ldquo;FieldNames&rdquo;, access = AccessLevel.PACKAGE); 如果想统一修改内部类名，可以修改 lombok 配置文件</p>
<pre tabindex="0"><code>lombok.fieldNameConstants.innerTypeName
</code></pre></li>
</ol>
<h2 id="7子类继承父类父类属性不生效">7、子类继承父类，父类属性不生效</h2>
<p>子类增加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@ToString</span>(callSuper <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EqualsAndHashCode</span>(callSuper <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>)
</span></span></code></pre></div><h2 id="问题41使用optional和stream解决list的npe问题">问题41、使用Optional和stream解决List的NPE问题</h2>
<p><strong>如果整个 list 可能为 null</strong>，用 Optional 包装一下</p>
<p><strong>如果 list 中的某个 object 可能为 null</strong>，用 .filter(Objects::nonNull)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> personList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    personList.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> Person());
</span></span><span style="display:flex;"><span>    personList.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    personList.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> Person(<span style="color:#e6db74">&#34;小明&#34;</span>, 10));
</span></span><span style="display:flex;"><span>    personList.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> Person(<span style="color:#e6db74">&#34;小红&#34;</span>, 12));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Optional.<span style="color:#a6e22e">ofNullable</span>(personList).<span style="color:#a6e22e">orElseGet</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;personList 为 null ！&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    }).<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(Objects::nonNull).<span style="color:#a6e22e">forEach</span>(person <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(person.<span style="color:#a6e22e">getName</span>());
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(person.<span style="color:#a6e22e">getAge</span>());
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><h2 id="问题42springboot上传文件大小限制的配置">问题42、SpringBoot上传文件大小限制的配置</h2>
<p>使用SpingBoot框架上传文件时，如果文件大小超过了1MB，会报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">Maximum</span> <span style="color:#a6e22e">upload</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">exceeded</span>; <span style="color:#a6e22e">nested</span> <span style="color:#a6e22e">exception</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">java</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IllegalStateException</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">tomcat</span><span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">http</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fileupload</span><span style="color:#f92672">.</span><span style="color:#a6e22e">FileUploadBase</span>$FileSizeLimitExceededException<span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">The</span> <span style="color:#a6e22e">field</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">exceeds</span> <span style="color:#a6e22e">its</span> <span style="color:#a6e22e">maximum</span> <span style="color:#a6e22e">permitted</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">of</span> <span style="color:#ae81ff">1048576</span> <span style="color:#a6e22e">bytes</span>
</span></span></code></pre></div><p>原因是SpringBoot内置的Tomcat的文件传输默认单个文件最大1M，单次请求文件总数大小为10M。
解决方法：
可以在SpingBoot的application.yml配置文件中进行修改</p>
<p>SpingBoot2.0版本之前：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">multipart</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxFileSize</span>: <span style="color:#ae81ff">20MB </span> <span style="color:#75715e">#单个文件最大为20M</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxRequestSize</span>: <span style="color:#ae81ff">20MB</span> <span style="color:#75715e">#单次请求文件总数大小为20M</span>
</span></span></code></pre></div><p>SpingBoot2.0版本之后：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">servlet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">multipart</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max-file-size</span>: <span style="color:#ae81ff">20MB</span> <span style="color:#75715e">#单个文件最大为20M</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max-request-size</span>: <span style="color:#ae81ff">20MB</span> <span style="color:#75715e">#单次请求文件总数大小为20M</span>
</span></span></code></pre></div><h2 id="问题43mybatisplus调用saveorupdatebatch报npe问题">问题43、mybatisplus调用saveOrUpdateBatch报NPE问题</h2>
<p>注意可能不是调用传入的List为空的所导致的，</p>
<p>建议进入saveOrUpdateBatch的源码进行逐步调试，此次问题是由<code>getById</code>导致的，原因是：<code>getById</code>时调用数据库sql查找对象，由于mybatisPlus的下划线转驼峰的设定，有个字段<code>a__b_c</code>转为驼峰后又在<code>getById</code>调用时转回下划线变成了<code>a_b_c</code>，导致列名没有匹配上。</p>
<blockquote>
<p>无效的列名：【xxxxx】</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@Transactional</span>(rollbackFor <span style="color:#f92672">=</span> Exception.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">saveOrUpdateBatch</span>(Collection<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> entityList, <span style="color:#66d9ef">int</span> batchSize) {
</span></span><span style="display:flex;"><span>        TableInfo tableInfo <span style="color:#f92672">=</span> TableInfoHelper.<span style="color:#a6e22e">getTableInfo</span>(entityClass);
</span></span><span style="display:flex;"><span>        Assert.<span style="color:#a6e22e">notNull</span>(tableInfo, <span style="color:#e6db74">&#34;error: can not execute. because can not find cache of TableInfo for entity!&#34;</span>);
</span></span><span style="display:flex;"><span>        String keyProperty <span style="color:#f92672">=</span> tableInfo.<span style="color:#a6e22e">getKeyProperty</span>();
</span></span><span style="display:flex;"><span>        Assert.<span style="color:#a6e22e">notEmpty</span>(keyProperty, <span style="color:#e6db74">&#34;error: can not execute. because can not find column for id from entity!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> executeBatch(entityList, batchSize, (sqlSession, entity) <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            Object idVal <span style="color:#f92672">=</span> ReflectionKit.<span style="color:#a6e22e">getMethodValue</span>(entityClass, entity, keyProperty);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">checkValNull</span>(idVal) <span style="color:#f92672">||</span> Objects.<span style="color:#a6e22e">isNull</span>(getById((Serializable) idVal))) {
</span></span><span style="display:flex;"><span>                sqlSession.<span style="color:#a6e22e">insert</span>(tableInfo.<span style="color:#a6e22e">getSqlStatement</span>(SqlMethod.<span style="color:#a6e22e">INSERT_ONE</span>.<span style="color:#a6e22e">getMethod</span>()), entity);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                MapperMethod.<span style="color:#a6e22e">ParamMap</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> param <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MapperMethod.<span style="color:#a6e22e">ParamMap</span><span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>                param.<span style="color:#a6e22e">put</span>(Constants.<span style="color:#a6e22e">ENTITY</span>, entity);
</span></span><span style="display:flex;"><span>                sqlSession.<span style="color:#a6e22e">update</span>(tableInfo.<span style="color:#a6e22e">getSqlStatement</span>(SqlMethod.<span style="color:#a6e22e">UPDATE_BY_ID</span>.<span style="color:#a6e22e">getMethod</span>()), param);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>至于报NPE的原因在于mybatisPlus进行了异常捕获。<code> throw Objects.requireNonNull(myBatisExceptionTranslator.translateExceptionIfPossible((RuntimeException) unwrapped));</code>在这里将捕获的无效的列名的异常，给转化成了requireNonNull的异常抛出，故显示为NPE问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Deprecated</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">executeBatch</span>(Consumer<span style="color:#f92672">&lt;</span>SqlSession<span style="color:#f92672">&gt;</span> consumer) {
</span></span><span style="display:flex;"><span>        SqlSessionFactory sqlSessionFactory <span style="color:#f92672">=</span> SqlHelper.<span style="color:#a6e22e">sqlSessionFactory</span>(entityClass);
</span></span><span style="display:flex;"><span>        SqlSessionHolder sqlSessionHolder <span style="color:#f92672">=</span> (SqlSessionHolder) TransactionSynchronizationManager.<span style="color:#a6e22e">getResource</span>(sqlSessionFactory);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> transaction <span style="color:#f92672">=</span> TransactionSynchronizationManager.<span style="color:#a6e22e">isSynchronizationActive</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (sqlSessionHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            SqlSession sqlSession <span style="color:#f92672">=</span> sqlSessionHolder.<span style="color:#a6e22e">getSqlSession</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//原生无法支持执行器切换，当存在批量操作时，会嵌套两个session的，优先commit上一个session</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//按道理来说，这里的值应该一直为false。</span>
</span></span><span style="display:flex;"><span>            sqlSession.<span style="color:#a6e22e">commit</span>(<span style="color:#f92672">!</span>transaction);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        SqlSession sqlSession <span style="color:#f92672">=</span> sqlSessionFactory.<span style="color:#a6e22e">openSession</span>(ExecutorType.<span style="color:#a6e22e">BATCH</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>transaction) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;SqlSession [&#34;</span> <span style="color:#f92672">+</span> sqlSession <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] was not registered for synchronization because DataSource is not transactional&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            consumer.<span style="color:#a6e22e">accept</span>(sqlSession);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//非事物情况下，强制commit。</span>
</span></span><span style="display:flex;"><span>            sqlSession.<span style="color:#a6e22e">commit</span>(<span style="color:#f92672">!</span>transaction);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Throwable t) {
</span></span><span style="display:flex;"><span>            sqlSession.<span style="color:#a6e22e">rollback</span>();
</span></span><span style="display:flex;"><span>            Throwable unwrapped <span style="color:#f92672">=</span> ExceptionUtil.<span style="color:#a6e22e">unwrapThrowable</span>(t);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (unwrapped <span style="color:#66d9ef">instanceof</span> RuntimeException) {
</span></span><span style="display:flex;"><span>                MyBatisExceptionTranslator myBatisExceptionTranslator
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyBatisExceptionTranslator(sqlSessionFactory.<span style="color:#a6e22e">getConfiguration</span>().<span style="color:#a6e22e">getEnvironment</span>().<span style="color:#a6e22e">getDataSource</span>(), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> Objects.<span style="color:#a6e22e">requireNonNull</span>(myBatisExceptionTranslator.<span style="color:#a6e22e">translateExceptionIfPossible</span>((RuntimeException) unwrapped));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> ExceptionUtils.<span style="color:#a6e22e">mpe</span>(unwrapped);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            sqlSession.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="问题44resttemplate调用post接口">问题44、restTemplate调用post接口</h2>
<p><code>postForObject</code>及其他方法中的Object request，传入param和header实例</p>
<p><img src="/images/image-20210624141038333.png" alt="image-20210624141038333"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isBlank</span>(username) <span style="color:#f92672">||</span> StringUtils.<span style="color:#a6e22e">isBlank</span>(orgName)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ServiceException(<span style="color:#e6db74">&#34;接口参数不能为空&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// uri</span>
</span></span><span style="display:flex;"><span>        String uri <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://198.120.100.105:18467/user/SyncUser&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// request body map</span>
</span></span><span style="display:flex;"><span>        JSONObject jsonObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject();
</span></span><span style="display:flex;"><span>        jsonObject.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;username&#34;</span>, username);
</span></span><span style="display:flex;"><span>        jsonObject.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;avatar&#34;</span>, orgName);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// header map</span>
</span></span><span style="display:flex;"><span>        HttpHeaders headers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpHeaders();
</span></span><span style="display:flex;"><span>        headers.<span style="color:#a6e22e">add</span>(<span style="color:#e6db74">&#34;code&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>        headers.<span style="color:#a6e22e">add</span>(<span style="color:#e6db74">&#34;INNER_ACCESS&#34;</span>, <span style="color:#e6db74">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 组装请求体</span>
</span></span><span style="display:flex;"><span>        HttpEntity<span style="color:#f92672">&lt;</span>JSONObject<span style="color:#f92672">&gt;</span> httpEntity <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> HttpEntity<span style="color:#f92672">&lt;&gt;</span>(jsonObject, headers);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">buildSuccess</span>(
</span></span><span style="display:flex;"><span>                    restTemplate.<span style="color:#a6e22e">postForObject</span>(uri, httpEntity, Result.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Result.<span style="color:#a6e22e">buildFailed</span>();
</span></span></code></pre></div><h2 id="问题45configurationproperties自定义配置属性类并实现ide自动提示">问题45、@ConfigurationProperties自定义配置属性类并实现IDE自动提示</h2>
<p>配置类声明如下，<strong>Spring 宽松绑定规则 (relaxed binding)</strong>：能够支持属性不严格绑定，不一定限定在驼峰。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 或者将@Component替换为@EnableConfigurationProperties(value = TestProperties.class)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ConfigurationProperties</span>(prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// @RefreshScope</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Getter</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Setter</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestProperties</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/**作者*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer port <span style="color:#f92672">=</span> 8080;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String pass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>配合spring-boot-configuration-processor使用</strong>，引入maven依赖，并且maven reimport</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>声明好配置类<code>TestProperties</code>之后，maven rebuild即可在<code>yaml</code>文件中自动映射到<code>test</code></p>
<h2 id="问题46springboot热部署">问题46、springboot热部署</h2>
<p><strong>覆盖的范围</strong>：修改的类、配置文件，对修改的这些文件进行重新加载。</p>
<p><strong>1. 引入spring boot devtools，添加maven依赖</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>         <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-devtools<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><strong>2. 在maven中添加插件</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>            <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">&lt;!--fork :  如果没有该项配置，则devtools不会起作用，即应用不会restart --&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;fork&gt;</span>true<span style="color:#f92672">&lt;/fork&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;addResources&gt;</span>true<span style="color:#f92672">&lt;/addResources&gt;</span><span style="color:#75715e">&lt;!--支持静态文件热部署--&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><h2 id="问题47spring-boot启动时执行初始化操作">问题47、Spring Boot启动时执行初始化操作</h2>
<h3 id="1postconstruct">1、@PostConstruct</h3>
<p>对于注入到Spring容器中的类，在其成员函数前添加@PostConstruct注解，则在执行Spring beans初始化时，就会执行该函数。</p>
<p>但由于该函数执行时，其他Spring beans可能并未初始化完成，因此在该函数中执行的初始化操作应当不依赖于其他Spring beans。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Construct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@PostConstruct</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doConstruct</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;初始化：PostConstruct&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2commandlinerunner">2、@CommandLineRunner</h3>
<p><code>CommandLineRunner</code>是Spring提供的接口，定义了一个run()方法，用于执行初始化操作</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InitCommandLineRunner</span> <span style="color:#66d9ef">implements</span> CommandLineRunner {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(String... args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;初始化：InitCommandLineRunner&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>CommandLineRunner</code>的时机为Spring beans初始化之后，因此<code>CommandLineRunner</code>的执行一定是晚于<code>@PostConstruct</code>的。</p>
<p>若有多组初始化操作，则每一组操作都要定义一个<code>CommandLineRunner</code>派生类并实现run()方法。这些操作的执行顺序使用@Order(n)来设置，n为int型数据</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Order</span>(99)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommandLineRunnerA</span> <span style="color:#66d9ef">implements</span> CommandLineRunner {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(String... args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;初始化：CommandLineRunnerA&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Order</span>(1)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CommandLineRunnerB</span> <span style="color:#66d9ef">implements</span> CommandLineRunner {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(String... args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;初始化：CommandLineRunnerB&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如上，会先执行<code>CommandLineRunnerB</code>的run()，再执行<code>CommandLineRunnerA</code>的run()。<code>@Order(n)</code>中的n较小的会先执行，较大的后执行。n只要是int值即可，无需顺序递增。</p>
<h3 id="3applicationrunner">3、ApplicationRunner</h3>
<p><code>ApplicationRunner</code>接口与<code>CommandLineRunner</code>接口类似，都需要实现run()方法。二者的区别在于run()方法的参数不同：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InitApplicationRunner</span> <span style="color:#66d9ef">implements</span> ApplicationRunner {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(ApplicationArguments applicationArguments) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;初始化：InitApplicationRunner&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>ApplicationRunner</code>接口的<code>run()</code>参数为<code>ApplicationArguments</code>对象，因此可以获取更多项目相关的内容。</p>
<p><code>ApplicationRunner</code>接口与<code>CommandLineRunner</code>接口的调用时机也是相同的，都是Spring beans初始化之后。</p>
<p>因此<code>ApplicationRunner</code>接口也使用<code>@Order(n)</code>来设置执行顺序。</p>
<h2 id="问题50springboot单元测试">问题50、springboot单元测试</h2>
<p>1、在src目录下建立 test.java 目录，作为单元测试根目录</p>
<p>2、创建父类，在需要创建单元测试的类上alt+enter，create tests，选择superClass和需要单元测试的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 类 AppApplicationTests&lt;code&gt;Doc&lt;/code&gt;用于：单元测试主类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @author 罗皓
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @date 2022/5/12 14:24
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RunWith</span>(SpringRunner.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ActiveProfiles</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">//由于是Web项目，Junit需要模拟ServletContext，因此我们需要给我们的测试类加上@WebAppConfiguration。</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@WebAppConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AppApplicationTests</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Before</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;开始测试-----------------&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@After</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">after</span>() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;测试结束-----------------&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>3、针对controller，示例如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 类 OpsDevConfigControllerTest&lt;code&gt;Doc&lt;/code&gt;用于：Controller测试包
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @author 罗皓
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @date 2022/5/12 14:26
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@AutoConfigureMockMvc</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OpsDevConfigControllerTest</span> <span style="color:#66d9ef">extends</span> AppApplicationTests {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> MockMvc mockMvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@BeforeEach</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUp</span>(WebApplicationContext context) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//集成Web环境方法</span>
</span></span><span style="display:flex;"><span>        mockMvc <span style="color:#f92672">=</span> MockMvcBuilders.<span style="color:#a6e22e">webAppContextSetup</span>(context).<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// @Ignore</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getOpsDevConfigDeviceType</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        mockMvc.<span style="color:#a6e22e">perform</span>(MockMvcRequestBuilders.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/ops-dev-config/device-type/access&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andDo</span>(MockMvcResultHandlers.<span style="color:#a6e22e">print</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(MockMvcResultMatchers.<span style="color:#a6e22e">status</span>().<span style="color:#a6e22e">isOk</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getOpsDevConfigById</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        MvcResult mvcResult <span style="color:#f92672">=</span> mockMvc.<span style="color:#a6e22e">perform</span>(MockMvcRequestBuilders.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;/ops-dev-config/333/access&#34;</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andDo</span>(MockMvcResultHandlers.<span style="color:#a6e22e">print</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andExpect</span>(MockMvcResultMatchers.<span style="color:#a6e22e">status</span>().<span style="color:#a6e22e">isOk</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">andReturn</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;=== 打印 ===&#34;</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(mvcResult.<span style="color:#a6e22e">getResponse</span>().<span style="color:#a6e22e">getContentAsString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>4、针对service，示例如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 类 OpsDevConfigServiceImplTest&lt;code&gt;Doc&lt;/code&gt;用于：TODO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @author 罗皓
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @date 2022/5/12 14:42
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OpsDevConfigServiceImplTest</span> <span style="color:#66d9ef">extends</span> AppApplicationTests {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IOpsDevConfigService iOpsDevConfigService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getOpsDevConfigById</span>() {
</span></span><span style="display:flex;"><span>        assertNotNull(iOpsDevConfigService.<span style="color:#a6e22e">getOpsDevConfigById</span>(<span style="color:#e6db74">&#34;333&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getAllDeviceType</span>() {
</span></span><span style="display:flex;"><span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> allDeviceType <span style="color:#f92672">=</span> iOpsDevConfigService.<span style="color:#a6e22e">getAllDeviceType</span>();
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(allDeviceType);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="问题51mybatis-plus-3-iservice事务分析">问题51、mybatis-plus 3 IService事务分析</h2>
<p>mybatis-plus 3已经引入了spring-tx，记得要在配置类中通过注解启用事务，spring-tx的<code>@EnableTransactionManagement</code>注解。</p>
<p>提供IService接口和ServiceImpl实现，其中只有标注了@Transactional(rollbackFor = Exception.class)的接口才做事务的回滚，基本为batch等需要执行批量操作的接口。</p>
<ol>
<li><code>@Transactional</code>默认回滚的是<code>RuntimeException</code>也就是说如果抛出的不是<code>RuntimeException</code>的异常，数据库是不会回滚的。但是所幸的是，在spring框架下，所有的异常都被<code>org.springframework</code>重写为<code>RuntimeException</code>，因此不需要太担心</li>
<li>还有如果在异常发生时，程序员自己手动捕获处理了，异常也不会回滚</li>
<li>如果使用的是统一异常处理，继承了<code>RuntimeException</code>，你只管直接抛异常就行，回滚、日志、统一异常都已经处理好了</li>
</ol>
<h2 id="问题52stream">问题52、stream</h2>
<h3 id="1stream流操作">1、stream流操作</h3>
<p>stream的降序排序和之前我们通过重写Comparable接口，实现降排相比，要节省很多代码，而用stream分页，一般用来裁剪数据。</p>
<p><strong>排序</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Student newList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>(10);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//升序</span>
</span></span><span style="display:flex;"><span>list.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">sorted</span>((v1,v2)<span style="color:#f92672">-&gt;</span>v1.<span style="color:#a6e22e">getId</span>().<span style="color:#a6e22e">compareTo</span>(
</span></span><span style="display:flex;"><span>	v2.<span style="color:#a6e22e">getId</span>()
</span></span><span style="display:flex;"><span>)).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//降序</span>
</span></span><span style="display:flex;"><span>list.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">sorted</span>((v1,v2)<span style="color:#f92672">-&gt;</span>v2getId().<span style="color:#a6e22e">compareTo</span>(
</span></span><span style="display:flex;"><span>	v1.<span style="color:#a6e22e">getId</span>()
</span></span><span style="display:flex;"><span>)).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//根据子对象id，升序排序，Student对象中还有一个Boy的对象属性</span>
</span></span><span style="display:flex;"><span>list.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">sorted</span>((v1,v2)<span style="color:#f92672">-&gt;</span>v1.<span style="color:#a6e22e">getBoy</span>().<span style="color:#a6e22e">getbId</span>().<span style="color:#a6e22e">compareTo</span>(
</span></span><span style="display:flex;"><span>	v2.<span style="color:#a6e22e">getBoy</span>().<span style="color:#a6e22e">getbId</span>()
</span></span><span style="display:flex;"><span>	)).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><p><strong>分页</strong></p>
<p><strong>skip：跳过n个元素，limit裁剪大小，currentPage当前页，pageSize当前页大小。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>list.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">skip</span>((currentPage<span style="color:#f92672">-</span>1)<span style="color:#f92672">*</span>pageSize).<span style="color:#a6e22e">limit</span>(pageSize).
</span></span><span style="display:flex;"><span>									collect(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><h3 id="2对象list集合各种操作">2、对象List集合各种操作</h3>
<p>==注意：使用distinct、contains时候需要实现bean类的equals、hashCode方法==</p>
<p>如果是使用的lombok，可以参照这种用法，include如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@EqualsAndHashCode</span>(onlyExplicitlyIncluded <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>, callSuper <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@TableName</span>(<span style="color:#e6db74">&#34;point_acquire&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ApiModel</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PointAcquire对象&#34;</span>, description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位表&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PointAcquire</span> <span style="color:#66d9ef">extends</span> SuperEntity<span style="color:#f92672">&lt;</span>PointAcquire<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Excel</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TableId</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;id&#34;</span>, type <span style="color:#f92672">=</span> IdType.<span style="color:#a6e22e">ASSIGN_UUID</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ApiModelProperty</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位编号&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Excel</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;采集点位编号&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@EqualsAndHashCode.Include</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String acquirePointCode;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>交集</strong>（listA ∩ ListB）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> listC <span style="color:#f92672">=</span> listA.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> listB.<span style="color:#a6e22e">contains</span>(item)).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><p>listC中的元素有：属性name值为 aa, bb, cc 的对象。</p>
<p><strong>并集（listA ∪ listB）:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//先合体</span>
</span></span><span style="display:flex;"><span>listA.<span style="color:#a6e22e">addAll</span>(listB);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//再去重</span>
</span></span><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> listC <span style="color:#f92672">=</span> listA.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">distinct</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><p>listC中的元素有：属性name值为 aa, bb, cc ,dd的对象。</p>
<p><strong>差集（listA - listB）:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Person<span style="color:#f92672">&gt;</span> listC <span style="color:#f92672">=</span> listA.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">!</span>listB.<span style="color:#a6e22e">contains</span>(item)).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><p>listC中的元素有：属性name值为 dd的对象。</p>
<p>过滤筛选：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 筛选总金额大于1000的订单</span>
</span></span><span style="display:flex;"><span>  orders <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> item.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">&gt;</span> 1000.<span style="color:#a6e22e">00f</span>).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span></code></pre></div><p>分组：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 按照订单类型分组</span>
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span>String, List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;&gt;</span> orderGroupMap <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">groupingBy</span>(Order::getType));
</span></span></code></pre></div><p>去重：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 按照订单编号去重</span>
</span></span><span style="display:flex;"><span>  orders <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">collectingAndThen</span>(Collectors.<span style="color:#a6e22e">toCollection</span>(()
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> TreeSet<span style="color:#f92672">&lt;&gt;</span>(Comparator.<span style="color:#a6e22e">comparing</span>(Order::getNum))), ArrayList::<span style="color:#66d9ef">new</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 按照订单编号和类型去重</span>
</span></span><span style="display:flex;"><span>  orders <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">collectingAndThen</span>(Collectors.<span style="color:#a6e22e">toCollection</span>(()
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> TreeSet<span style="color:#f92672">&lt;&gt;</span>(Comparator.<span style="color:#a6e22e">comparing</span>(o <span style="color:#f92672">-&gt;</span> o.<span style="color:#a6e22e">getNum</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;;&#34;</span> <span style="color:#f92672">+</span> o.<span style="color:#a6e22e">getType</span>()))), ArrayList::<span style="color:#66d9ef">new</span>));
</span></span></code></pre></div><p>List 转 Map ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 将订单集合转换成订单编号-应付金额 map，注意订单编号作为 key 不能重复，应先做去重处理</span>
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span>String, Float<span style="color:#f92672">&gt;</span> numPayMap <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toMap</span>(Order::getNum, Order::getPayAmt));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 用 id 做 key 将 List 转成 Map</span>
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span>Long, Order<span style="color:#f92672">&gt;</span> orderMap <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toMap</span>(Order::getId, item <span style="color:#f92672">-&gt;</span> item));
</span></span></code></pre></div><p>排序：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 按照订单总金额从高到低排序</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 方式一</span>
</span></span><span style="display:flex;"><span>  orders.<span style="color:#a6e22e">sort</span>((o1, o2)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> o1.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 1 : (o2.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 : o2.<span style="color:#a6e22e">getAllAmt</span>().<span style="color:#a6e22e">compareTo</span>(o1.<span style="color:#a6e22e">getAllAmt</span>())));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 方式二</span>
</span></span><span style="display:flex;"><span>  orders.<span style="color:#a6e22e">sort</span>(Comparator.<span style="color:#a6e22e">comparing</span>(Order::getAllAmt, (o1, o2)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> o1 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 1 : (o2 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 : o2.<span style="color:#a6e22e">compareTo</span>(o1))));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 方式三 (allAmt 字段不能为 null， null 会导致排序失败)</span>
</span></span><span style="display:flex;"><span>  orders.<span style="color:#a6e22e">sort</span>(Comparator.<span style="color:#a6e22e">comparing</span>(Order::getAllAmt).<span style="color:#a6e22e">reversed</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 先按照订单类型排序，再按照订单应付金额从高到低排序</span>
</span></span><span style="display:flex;"><span>  orders.<span style="color:#a6e22e">sort</span>(Comparator.<span style="color:#a6e22e">comparing</span>(Order::getType, (o1, o2)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> o1 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 1 : (o2 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 : o1.<span style="color:#a6e22e">compareTo</span>(o2))).<span style="color:#a6e22e">thenComparing</span>((o1, o2)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-&gt;</span> o1.<span style="color:#a6e22e">getPayAmt</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 1 : (o2.<span style="color:#a6e22e">getPayAmt</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span>1 : o2.<span style="color:#a6e22e">getPayAmt</span>().<span style="color:#a6e22e">compareTo</span>(o1.<span style="color:#a6e22e">getPayAmt</span>()))));
</span></span></code></pre></div><p>统计计数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Order<span style="color:#f92672">&gt;</span> orders <span style="color:#f92672">=</span> Lists.<span style="color:#a6e22e">newArrayList</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 统计所有订单的总金额</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 求和</span>
</span></span><span style="display:flex;"><span>  Double sum <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> item.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">mapToDouble</span>(Order::getAllAmt).<span style="color:#a6e22e">sum</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 最大总金额</span>
</span></span><span style="display:flex;"><span>  OptionalDouble max <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> item.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">mapToDouble</span>(Order::getAllAmt).<span style="color:#a6e22e">max</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 防止没有订单数据的处理</span>
</span></span><span style="display:flex;"><span>  Double maxAllAmt <span style="color:#f92672">=</span> max.<span style="color:#a6e22e">isPresent</span>() <span style="color:#f92672">?</span> max.<span style="color:#a6e22e">getAsDouble</span>() : 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 最小总金额</span>
</span></span><span style="display:flex;"><span>  OptionalDouble min <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> item.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">mapToDouble</span>(Order::getAllAmt).<span style="color:#a6e22e">min</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 平均总金额</span>
</span></span><span style="display:flex;"><span>  OptionalDouble average <span style="color:#f92672">=</span> orders.<span style="color:#a6e22e">stream</span>().<span style="color:#a6e22e">filter</span>(item <span style="color:#f92672">-&gt;</span> item.<span style="color:#a6e22e">getAllAmt</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>).<span style="color:#a6e22e">mapToDouble</span>(Order::getAllAmt).<span style="color:#a6e22e">average</span>();
</span></span></code></pre></div><p>Stream中直接是取不到当前变量的索引值的,需要变相获取,这里提供2种方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        Integer<span style="color:#f92672">[]</span> inputArray <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer<span style="color:#f92672">[]</span>{1, 3, 5, 7, 9};
</span></span><span style="display:flex;"><span>        Integer<span style="color:#f92672">[]</span> out <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer<span style="color:#f92672">[</span>inputArray.<span style="color:#a6e22e">length</span><span style="color:#f92672">-</span>1<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//方法一 index就是自增索引</span>
</span></span><span style="display:flex;"><span>        AtomicInteger index<span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> AtomicInteger(0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Arrays.<span style="color:#a6e22e">stream</span>(inputArray).<span style="color:#a6e22e">map</span>(x<span style="color:#f92672">-&gt;</span>x<span style="color:#f92672">+</span>index.<span style="color:#a6e22e">getAndIncrement</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//方法二</span>
</span></span><span style="display:flex;"><span>        IntStream.<span style="color:#a6e22e">range</span>(0,inputArray.<span style="color:#a6e22e">length</span>).<span style="color:#a6e22e">mapToObj</span>(x<span style="color:#f92672">-&gt;</span>inputArray<span style="color:#f92672">[</span>x<span style="color:#f92672">]</span>).<span style="color:#a6e22e">collect</span>(Collectors.<span style="color:#a6e22e">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="问题53list-删除元素">问题53、list 删除元素</h2>
<p>最好使用迭代器 iterator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Iterator<span style="color:#f92672">&lt;?&gt;</span> it <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">iterator</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (it.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>    JSONObject jsonObject <span style="color:#f92672">=</span> (JSONObject) it.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>status.<span style="color:#a6e22e">equals</span>(jsonObject.<span style="color:#a6e22e">getString</span>(<span style="color:#e6db74">&#34;status&#34;</span>))) {
</span></span><span style="display:flex;"><span>        it.<span style="color:#a6e22e">remove</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Iterator.remove() 方法会在删除当前迭代对象的同时，会保留原来元素的索引。所以用迭代删除元素是最保险的方法，建议大家使用List过程，这其实和list.remove(index) 方法类似，只不过iterator内部帮我们做了类似i-1的操作。推荐使用这种做法，因为我们不保证每次都记得手动把下标 index 减去1。</p>
<h2 id="问题54fastjson">问题54、fastjson</h2>
<h3 id="各个对象转换">各个对象转换</h3>
<p>字符串、JSONObject、JSONarray</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String json<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{\&#34;name\&#34;:\&#34;刘德华\&#34;,\&#34;age\&#34;:35,\&#34;some\&#34;:[{\&#34;k1\&#34;:\&#34;v1\&#34;,\&#34;k2\&#34;:\&#34;v2\&#34;},{\&#34;k3\&#34;:\&#34;v3\&#34;,\&#34;k4\&#34;:\&#34;v4\&#34;}]}&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JSONObject jso<span style="color:#f92672">=</span>JSON.<span style="color:#a6e22e">parseObject</span>(json);<span style="color:#75715e">//json字符串转换成jsonobject对象</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JSONArray jsarr<span style="color:#f92672">=</span>jso.<span style="color:#a6e22e">getJSONArray</span>(<span style="color:#e6db74">&#34;some&#34;</span>);<span style="color:#75715e">//jsonobject对象取得some对应的jsonarray数组</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JSONObject ao<span style="color:#f92672">=</span>jsarr.<span style="color:#a6e22e">getJSONObject</span>(0);<span style="color:#75715e">//jsonarray对象通过getjsonobjext(index)方法取得数组里面的jsonobject对象</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>String vString<span style="color:#f92672">=</span>ao.<span style="color:#a6e22e">getString</span>(<span style="color:#e6db74">&#34;k1&#34;</span>);<span style="color:#75715e">//jsonobject对象通过key直接取得String的值</span>
</span></span></code></pre></div><p>1.Map转JSON</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;username&#34;</span>, <span style="color:#e6db74">&#34;yaomy&#34;</span>);
</span></span><span style="display:flex;"><span>map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;password&#34;</span>, <span style="color:#e6db74">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>JSONObject json <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject(map);
</span></span></code></pre></div><p>2.JSON转String</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        JSONObject json <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject();
</span></span><span style="display:flex;"><span>        json.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;username&#34;</span>, <span style="color:#e6db74">&#34;yaomy&#34;</span>);
</span></span><span style="display:flex;"><span>        json.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;password&#34;</span>, <span style="color:#e6db74">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        json.<span style="color:#a6e22e">toJSONString</span>();
</span></span></code></pre></div><p>3.JSON转Map</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        JSONObject json <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject();
</span></span><span style="display:flex;"><span>        json.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;username&#34;</span>, <span style="color:#e6db74">&#34;yaomy&#34;</span>);
</span></span><span style="display:flex;"><span>        json.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;password&#34;</span>, <span style="color:#e6db74">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> map <span style="color:#f92672">=</span> (Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span>)json;
</span></span></code></pre></div><p>4.String转JSON</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        String str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;{\&#34;username\&#34;:\&#34;yaomy\&#34;,\&#34;password\&#34;:\&#34;123\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>        JSONObject json <span style="color:#f92672">=</span> JSONObject.<span style="color:#a6e22e">parseObject</span>(str);
</span></span></code></pre></div><p>5.JSONObject转JAVABEAN</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        Person person <span style="color:#f92672">=</span> JSONObject.<span style="color:#a6e22e">toJavaObject</span>(jsonObject, Person.<span style="color:#a6e22e">class</span>);
</span></span></code></pre></div><p>6.JAVABEAN转JSONObject（将bean转为JSON）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        String jsonString<span style="color:#f92672">=</span>JSONObject.<span style="color:#a6e22e">toJSONString</span>(param);
</span></span><span style="display:flex;"><span>        JSONObject jSONObject<span style="color:#f92672">=</span>JSONObject.<span style="color:#a6e22e">parseObject</span>(jsonString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        JSONObject jsonObject <span style="color:#f92672">=</span> (JSONObject) JSONObject.<span style="color:#a6e22e">toJSON</span>(person);
</span></span></code></pre></div><p>7.javabean转string</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        JSON.<span style="color:#a6e22e">toJSONString</span>(user)
</span></span></code></pre></div><h3 id="将long类型转成string">将Long类型转成String</h3>
<p>前后端交互的时候，由于Long类型返回给前端时，如果数值过大，会导致精度丢失，后面几位会变成0，这时候就需要把Long转成String类型的返回给前端页面。</p>
<p>这时候如果专门为其写一个属性来存储，比较麻烦，需要改动的文件比较多。这时候可以使用fastJson里的标签</p>
<p>@JSONField(serializeUsing = ToStringSerializer.class)</p>
<p>只要在model类上的Long字段加上这个标签，则会返回前端时，把Long转成String</p>
<p>要注意的一点是。serializeUsing 这个属性是在fastjson 1.2.16后才有的。要检查下fastJson的版本</p>
<h3 id="自定义date类型反序列化">自定义Date类型反序列化</h3>
<p>在最新的fastjson库里(1.2.38, Sep, 2017)没有<code>DateFormatDeserializer</code>类或者<code>DateDeserializer</code>类。通过查看源代码，发现目前使用:<code>com.alibaba.fastjson.serializer.DateCodec</code>。</p>
<p>自定义类<code>SecondDeserializer</code>继承<code>DateCodec</code>，然后重写<code>cast</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecondDeserializer</span> <span style="color:#66d9ef">extends</span> DateCodec {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> SecondDeserializer instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SecondDeserializer();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">cast</span>(DefaultJSONParser parser, Type clazz, Object fieldName, Object val){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> value <span style="color:#f92672">=</span> Long.<span style="color:#a6e22e">valueOf</span>(String.<span style="color:#a6e22e">valueOf</span>(val)) <span style="color:#f92672">*</span> 1000;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">cast</span>(parser, clazz, fieldName, value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样，当json传来是的秒，能够转化为java中的Date类。</p>
<h3 id="返回结果为null属性不显示解决方法">返回结果为null属性不显示解决方法</h3>
<p>返回时null属性不显示：String str = JSONObject.toJSONString(obj);
返回为null属性显示：String str = JSONObject.toJSONString(obj,SerializerFeature.WriteMapNullValue);
Fastjson的SerializerFeature序列化属性</p>
<p>QuoteFieldNames———-输出key时是否使用双引号,默认为true。</p>
<p>WriteMapNullValue——–是否输出值为null的字段,默认为false。</p>
<p>WriteNullNumberAsZero—-数值字段如果为null,输出为0,而非null。</p>
<p>WriteNullListAsEmpty—–List字段如果为null,输出为[],而非null。</p>
<p>WriteNullStringAsEmpty—字符类型字段如果为null,输出为”“,而非null。</p>
<p>WriteNullBooleanAsFalse–Boolean字段如果为null,输出为false,而非null。</p>
<h2 id="问题55comparator升序降序的记法">问题55、Comparator升序降序的记法</h2>
<p>直接给出结论。从交换的角度去思考排序。</p>
<p>实现Comparator接口，必须实现下面这个函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span>(CommentVo o1, CommentVo o2) {
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">return</span> o1.<span style="color:#a6e22e">getTime</span>().<span style="color:#a6e22e">compareTo</span>(o2.<span style="color:#a6e22e">getTime</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里o1表示位于前面的对象，o2表示后面的对象</p>
<ul>
<li>返回-1（或负数），表示不需要交换01和02的位置，o1排在o2前面，asc</li>
<li>返回1（或正数），表示需要交换01和02的位置，o1排在o2后面，desc</li>
</ul>



  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/cn/2021/chrony%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9%E6%97%B6/">Linux——chrony 服务器集群对时</a></span>
  <span class="nav-next"><a href="/cn/2022/%E7%97%9B%E9%A3%8E%E5%98%8C%E5%91%A4%E9%A5%AE%E9%A3%9F%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/">痛风嘌呤饮食注意事项</a> &rarr;</span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/cn\/2021\/chrony%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AF%B9%E6%97%B6\/';
    
  } else if (e.which == 39) {  
    
    url = '\/cn\/2022\/%E7%97%9B%E9%A3%8E%E5%98%8C%E5%91%A4%E9%A5%AE%E9%A3%9F%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9\/';
    
  }
  if (url) window.location = url;
});
</script>






<script async src="/js/fix-toc.js"></script>

<script async src="/js/center-img.js"></script>

<script async src="/js/right-quote.js"></script>

<script async src="/js/no-highlight.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/alt-title.js"></script>

<script async src="/js/header-link.js"></script>



<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>


  























<script src="//cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js" defer></script>



  
  <hr>
  <div class="copyright">© <a href="/">Luo Hao</a> 2016 - 2024</div>
  
  </footer>
  </article>
  
  


  </body>
</html>

